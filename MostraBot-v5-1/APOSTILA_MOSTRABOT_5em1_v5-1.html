<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOSTRABOT 5em1 v5.1 - Apostila Completa para Professores</title>
    <style>
        @page { size: A4; margin: 1.5cm; }
        * { box-sizing: border-box; }
        :root {
            --primary: #1a5276;
            --secondary: #2874a6;
            --accent: #3498db;
            --bg-light: #f8f9fa;
            --border: #dee2e6;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --layout-sidebar-offset: 300px;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 11pt;
            line-height: 1.5;
            color: #333;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
        }
        .container {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
        }
        nav {
            width: 280px;
            background: var(--primary);
            color: white;
            padding: 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }
        nav h2 {
            color: white;
            font-size: 14pt;
            margin-bottom: 15px;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 10px;
        }
        nav a {
            color: rgba(255,255,255,0.9);
            text-decoration: none;
            display: block;
            padding: 8px 10px;
            margin: 2px 0;
            border-radius: 5px;
            font-size: 10pt;
        }
        nav a:hover { background: rgba(255,255,255,0.2); }
        nav a.active-nav {
            background: rgba(255,255,255,0.28);
            font-weight: 700;
        }
        main {
            margin-left: 300px;
            padding: 30px 40px;
            background: white;
            min-height: 100vh;
            flex: 1;
        }
        h1 {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            padding-bottom: 10px;
            font-size: 24pt;
            margin-top: 40px;
        }
        h1:first-of-type { margin-top: 0; }
        h2 {
            color: var(--secondary);
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
            font-size: 16pt;
            margin-top: 30px;
        }
        h3 {
            color: var(--accent);
            font-size: 13pt;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 10pt;
        }
        th, td {
            border: 1px solid var(--border);
            padding: 10px;
            text-align: left;
        }
        th {
            background: var(--bg-light);
            font-weight: 600;
            color: var(--primary);
        }
        tr:nth-child(even) { background: #fafafa; }
        pre {
            background: #f3f5f7;
            color: #333;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 10pt;
            line-height: 1.4;
            border: 2px solid #b8d9f5;
            margin: 0;
        }
        code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', monospace;
            font-size: 10pt;
            color: #c7254e;
        }
        .box {
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            background: var(--bg-light);
        }
        .box-warning {
            border-color: var(--warning);
            background: #fff3cd;
        }
        .box-danger {
            border-color: var(--danger);
            background: #f8d7da;
        }
        .box-success {
            border-color: var(--success);
            background: #d4edda;
        }
        .box-info {
            border-color: var(--accent);
            background: #d1ecf1;
        }
        .diagram {
            background: #f3f5f7;
            color: #333;
            padding: 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 9pt;
            line-height: 1.3;
            overflow-x: auto;
            white-space: pre;
            border: 2px solid #b8d9f5;
        }
        .pje-example {
            border: 2px solid #b8d9f5;
            background: #f7f9fb;
            border-radius: 10px;
            padding: 10px;
            margin: 15px 0;
        }
        .pje-label {
            font-size: 10pt;
            font-weight: bold;
            color: #2c6fb3;
            margin-bottom: 6px;
        }
        .pje-textarea {
            background: #f3f5f7;
            border: 2px solid #b8d9f5;
            border-radius: 6px;
            padding: 8px;
        }
        .pje-send {
            display: inline-block;
            margin-top: 8px;
            background: #5fc99a;
            color: #fff;
            padding: 6px 14px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 10pt;
        }
        .pje-tools {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        .copy-code-btn {
            border: 2px solid #2c6fb3;
            background: #e8f4ff;
            color: #1a5276;
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 9.5pt;
            font-weight: 700;
            cursor: pointer;
        }
        .copy-code-btn:hover {
            filter: brightness(0.97);
        }
        .copy-status {
            font-size: 9pt;
            color: #1c7c4c;
            font-weight: 700;
        }
        .shape-diagram {
            background: #f7f9fb;
            border: 2px dashed #b8d9f5;
            border-radius: 8px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 9pt;
            color: #2c3e50;
            white-space: pre;
            margin: 10px 0;
        }
        .header-banner {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
        }
        .header-banner h1 {
            color: white;
            border: none;
            font-size: 28pt;
            margin: 0;
        }
        .header-banner p {
            margin: 10px 0 0 0;
            font-size: 12pt;
            opacity: 0.9;
        }
        .signal-table td:first-child {
            font-weight: bold;
            width: 40%;
        }
        .module-img {
            width: 100%;
            max-width: 900px;
            display: block;
            margin: 15px auto;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: white;
        }
        .mvp-img {
            max-width: 500px;
        }
        
        .didactic-img {
            max-width: 500px;
        }
        
        .icon-inline {
            width: 54px;
            height: 54px;
            vertical-align: -8px;
            margin-right: 6px;
        }
        
        
        .mission-header {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 12px;
            align-items: center;
            border: 2px solid #b8d9f5;
            background: #f7fbff;
            border-radius: 14px;
            padding: 12px 14px;
            margin: 12px 0 18px 0;
        }
        .mission-name {
            font-weight: 800;
            color: #1a5276;
            font-size: 12pt;
        }
        .mission-goal {
            font-size: 10pt;
            color: #333;
            margin-top: 4px;
        }
        .mission-badges {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        .mission-badge {
            padding: 4px 8px;
            border-radius: 999px;
            background: #e8f4ff;
            color: #1a5276;
            font-weight: 700;
            font-size: 9pt;
        }
        .mission-reward {
            margin-top: 6px;
            font-size: 9pt;
            color: #7f5600;
            background: #f1c40f;
            display: inline-block;
            padding: 3px 8px;
            border-radius: 8px;
            font-weight: 700;
        }
        
        .lesson-toggle { cursor: pointer; }
        .lesson-toggle::after {
            content: '▼';
            float: right;
            font-size: 12pt;
            color: #1a5276;
        }
        .lesson-toggle.collapsed::after { content: '▶'; }
        .lesson-content { margin-bottom: 24px; }
        .lesson-content.collapsed { display: none; }
        .lesson-hint { font-size: 9pt; color: #555; }
            .mission-task {
            border: 2px dashed #b8d9f5;
            background: #f7f9fb;
            border-radius: 12px;
            padding: 10px 12px;
            margin: 12px 0;
        }
        .mission-task-title {
            font-weight: 800;
            color: #2c6fb3;
        }
        .task-row {
            display: block;
            gap: 8px;
            margin: 10px 0;
            border: 2px solid #9fd4ff;
            border-radius: 12px;
            padding: 10px;
            background: linear-gradient(180deg, #ffffff, #f2fbff);
        }
        .task-row.task-row-hidden {
            display: none;
        }
        .task-row.done {
            opacity: 1;
            border-color: #35c36e;
            background: linear-gradient(180deg, #edfff3, #dafbe6);
            box-shadow: inset 0 0 0 2px rgba(53,195,110,0.22);
        }
        .task-row.done .task-text {
            text-decoration: none;
        }
        .task-text {
            display: block;
            font-weight: 700;
            color: #0e4668;
            margin-bottom: 8px;
        }
        .task-help {
            display: block;
            color: #8a2e00;
            font-size: 9pt;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .task-visual {
            margin: 8px 0 10px 0;
        }
        .task-visual img {
            width: 100%;
            max-width: 460px;
            border: 2px solid #b8d9f5;
            border-radius: 10px;
            background: #fff;
            display: block;
        }
        .robot-signal-card {
            margin: 12px 0;
            border: 2px solid #ffd07d;
            border-radius: 12px;
            background: linear-gradient(180deg, #fffdf1, #fff4d7);
            padding: 10px;
        }
        .robot-signal-title {
            font-weight: 800;
            color: #8a2e00;
            margin-bottom: 8px;
        }
        .robot-signal-figure {
            position: relative;
            width: 100%;
            max-width: 360px;
            margin: 8px auto;
        }
        .robot-signal-figure img {
            width: 100%;
            display: block;
            border-radius: 10px;
            border: 2px solid #ffd07d;
            background: #fff;
        }
        .signal-dot {
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 999px;
            border: 3px solid #ff4d4d;
            box-shadow: 0 0 0 3px rgba(255, 77, 77, 0.25);
            background: rgba(255, 255, 255, 0.8);
        }
        .signal-led-dir { top: 42%; left: 62%; }
        .signal-led-esq { top: 42%; left: 34%; }
        .signal-buzzer { top: 70%; left: 49%; border-color: #ffa000; box-shadow: 0 0 0 3px rgba(255, 160, 0, 0.25); }
        .signal-tag {
            position: absolute;
            padding: 3px 6px;
            font-size: 8.5pt;
            font-weight: 800;
            border-radius: 8px;
            color: #083a56;
            background: #cfeeff;
            border: 1px solid #7ec9f5;
            white-space: nowrap;
        }
        .tag-led-dir { top: 30%; left: 67%; }
        .tag-led-esq { top: 30%; left: 6%; }
        .tag-buzzer { top: 76%; left: 58%; }
        .awake-status {
            margin-top: 10px;
            border-radius: 12px;
            padding: 10px;
            font-weight: 800;
            text-align: center;
        }
        .awake-status.locked {
            background: #eef2f7;
            border: 2px dashed #95a5a6;
            color: #5f6c7a;
        }
        .awake-status.ready {
            background: linear-gradient(180deg, #ecfff3, #cfffe2);
            border: 2px solid #2ecc71;
            color: #0b6b36;
        }
        .task-complete-btn {
            border: 2px solid #ff7f11;
            background: linear-gradient(180deg, #fff4e8, #ffe2c2);
            color: #8a2e00;
            border-radius: 12px;
            padding: 12px 14px;
            font-size: 10.5pt;
            font-weight: 800;
            cursor: pointer;
            white-space: normal;
            width: 100%;
            min-height: 52px;
            text-align: center;
            box-shadow: 0 0 0 3px rgba(255,127,17,0.18);
        }
        .task-complete-btn.done {
            border-color: #00b894;
            background: linear-gradient(180deg, #e7fff7, #c6ffe8);
            color: #00664d;
            box-shadow: 0 0 0 3px rgba(0,184,148,0.16);
        }
        .mission-finish-wrap {
            margin-top: 14px;
            display: block;
        }
        .mission-finish-btn {
            border: 2px solid #ffbf00;
            background: linear-gradient(180deg, #fff7d1, #ffe58a);
            color: #7a4b00;
            border-radius: 12px;
            padding: 12px 14px;
            font-size: 11pt;
            font-weight: 800;
            cursor: pointer;
            width: 100%;
            min-height: 54px;
            text-align: center;
        }
        .mission-finish-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .mission-finish-btn:not(:disabled) {
            box-shadow: 0 0 0 3px rgba(255,191,0,0.25);
        }
        .mission-finish-btn.done {
            border-color: #00b894;
            background: linear-gradient(180deg, #e9fff8, #c6ffe8);
            color: #005640;
            box-shadow: 0 0 0 3px rgba(0,184,148,0.2);
        }
        .mission-finish-state {
            display: block;
            margin-top: 8px;
            font-size: 9.5pt;
            color: #1c7c4c;
            font-weight: 700;
        }
        .cloud-links {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        .cloud-link {
            text-decoration: none;
            border: 2px solid #6ac4ff;
            background: linear-gradient(180deg, #f0fbff, #dff5ff);
            color: #0e4668;
            font-weight: 700;
            border-radius: 999px;
            padding: 6px 11px;
            font-size: 9.5pt;
        }
        .cloud-link:hover {
            background: #e3f1ff;
        }
        .external-hint {
            margin-top: 8px;
            font-size: 9pt;
            color: #8a2e00;
            font-weight: 700;
        }
        .mission-mini-hud {
            margin: 8px 0 10px 0;
            padding: 8px 10px;
            border-radius: 10px;
            border: 2px solid #7ec9f5;
            background: linear-gradient(180deg, #f2fbff, #dff5ff);
            color: #0e4668;
            font-weight: 800;
            font-size: 9.2pt;
        }
        .mission-inline-checklist {
            margin: 8px 0 10px 0;
            padding: 8px 10px;
            border-radius: 10px;
            border: 2px dashed #ffd166;
            background: #fff8e1;
            font-size: 9.2pt;
            font-weight: 700;
            color: #6d4c00;
        }
        .mission-inline-checklist ul {
            margin: 6px 0 0 16px;
            padding: 0;
        }
        .mini-review-link {
            display: inline-block;
            margin-top: 6px;
            font-weight: 800;
            color: #0e4668;
        }
        .ms-box {
            margin-top: 10px;
            padding: 10px;
            border-radius: 10px;
            border: 2px solid #b8d9f5;
            background: #f7fbff;
            font-size: 9.4pt;
            color: #0e4668;
        }
        .mascot-strip {
            margin-top: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
            gap: 10px;
        }
        .mascot-card {
            border: 2px solid #ffd166;
            border-radius: 12px;
            background: linear-gradient(180deg, #fffaf0, #fff3de);
            padding: 10px;
            text-align: center;
        }
        .mascot-card img {
            width: 150px;
            height: auto;
            border-radius: 10px;
            border: 2px solid #ffb347;
            background: #fff;
        }
        .mascot-title {
            margin-top: 8px;
            font-weight: 800;
            color: #8a2e00;
        }
        .mascot-text {
            font-size: 9.5pt;
            color: #6a3906;
            margin-top: 4px;
        }
            .lesson-card {
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 18px;
            margin: 18px 0;
            background: #f7f9fb;
        }
        .lesson-title {
            font-size: 13pt;
            color: var(--primary);
            margin-bottom: 8px;
            font-weight: 700;
        }
        .lesson-goal {
            font-weight: 600;
            margin-bottom: 10px;
        }
        .module-caption {
            text-align: center;
            font-size: 10pt;
            color: #555;
            margin-top: 6px;
        }
        .indice-box {
            border: 2px solid var(--border);
            background: var(--bg-light);
            border-radius: 12px;
            padding: 18px;
            margin: 10px 0 30px 0;
        }
        .indice-title {
            font-size: 16pt;
            color: var(--primary);
            margin: 0 0 10px 0;
            border-bottom: 2px solid var(--border);
            padding-bottom: 6px;
        }
        .indice-list {
            list-style: none;
            padding: 0;
            margin: 0;
            columns: 2;
            column-gap: 24px;
        }
        .indice-list li {
            margin: 6px 0;
            break-inside: avoid;
        }
        .indice-list a {
            color: #2c6fb3;
            text-decoration: none;
            font-weight: 600;
        }
        .indice-list a:hover {
            text-decoration: underline;
        }
        
        body {
            background: radial-gradient(1200px 600px at 10% 0%, #e8f4ff, #f5f5f5);
        }
        .game-hero {
            background: linear-gradient(135deg, #1a5276, #2c6fb3 50%, #5fc99a);
            color: white;
            padding: 28px;
            border-radius: 16px;
            margin: 10px 0 25px 0;
            position: relative;
            overflow: hidden;
        }
        .start-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 12px;
            margin: 0 0 14px 0;
        }
        .step-panel {
            border: 2px solid #9fd4ff;
            border-radius: 14px;
            background: linear-gradient(180deg, #f7fcff, #edf8ff);
            padding: 12px;
            box-shadow: 0 6px 16px rgba(44,111,179,0.12);
        }
        .step-kicker {
            display: inline-block;
            border-radius: 999px;
            padding: 3px 9px;
            background: #ffe7b8;
            border: 1px solid #ffbe55;
            color: #8a4b00;
            font-size: 8.5pt;
            font-weight: 800;
            margin-bottom: 6px;
        }
        .step-panel h3 {
            margin: 0 0 6px 0;
            color: #0e4668;
            font-size: 12.5pt;
        }
        .step-panel p {
            margin: 0 0 8px 0;
            color: #0e4668;
            font-size: 9.8pt;
        }
        .robot-guide-btn {
            width: 100%;
            border: 2px solid #ff9f1c;
            border-radius: 14px;
            background: linear-gradient(180deg, #fff7de, #ffedd0);
            padding: 10px;
            cursor: pointer;
            text-align: center;
            color: #8a2e00;
            font-weight: 700;
        }
        .robot-hero-img {
            width: 230px;
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto 8px auto;
            border-radius: 14px;
            border: 3px solid #ffb347;
            background: #fff;
            animation: float 3s ease-in-out infinite;
        }
        .robot-guide-btn:hover {
            filter: brightness(0.98);
        }
        .roadmap-panel {
            margin: 12px 0 14px 0;
            border: 2px solid #6ac4ff;
            border-radius: 14px;
            background: linear-gradient(180deg, #f4fbff, #e9f8ff);
            overflow: hidden;
        }
        .roadmap-panel > summary {
            cursor: pointer;
            list-style: none;
            font-weight: 800;
            color: #0e4668;
            padding: 12px 14px;
            background: linear-gradient(180deg, #dff5ff, #d0efff);
            border-bottom: 2px solid #9bd9ff;
        }
        .roadmap-panel > summary::-webkit-details-marker {
            display: none;
        }
        .roadmap-panel > summary::after {
            content: ' +';
            font-weight: 900;
            color: #00897b;
        }
        .roadmap-panel[open] > summary::after {
            content: ' -';
        }
        .roadmap-content {
            padding: 10px 12px 12px 12px;
        }
        .game-hero h2 {
            color: white;
            border: none;
            margin: 0 0 8px 0;
        }
        .game-hero p { margin: 6px 0; }
        .game-hero .sparkle {
            position: absolute;
            right: -30px;
            top: -30px;
            width: 140px;
            height: 140px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }
        .progress-track {
            background: rgba(255,255,255,0.25);
            border-radius: 999px;
            overflow: hidden;
            height: 12px;
            margin: 10px 0 0 0;
        }
        .progress-fill {
            width: 35%;
            height: 100%;
            background: #f1c40f;
            animation: pulse 2.5s ease-in-out infinite;
        }
        .mission-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
            margin: 14px 0 24px 0;
        }
        .mission-card {
            border: 2px solid #b8d9f5;
            border-radius: 14px;
            padding: 14px;
            background: #ffffff;
            box-shadow: 0 8px 20px rgba(0,0,0,0.06);
            transform: translateY(0);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .mission-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.1);
        }
        .mission-card.is-active {
            border-color: #ff7f11;
            box-shadow: 0 0 0 4px rgba(255,127,17,0.25);
            background: linear-gradient(180deg, #fff9f2, #ffffff);
        }
        .mission-card.is-dimmed {
            opacity: 0.45;
        }
        .mission-card.is-locked {
            opacity: 0.35;
            filter: grayscale(0.25);
            position: relative;
        }
        .mission-card.is-locked::after {
            content: 'Fase bloqueada';
            position: absolute;
            right: 10px;
            top: 10px;
            background: #fff3cd;
            border: 1px solid #f1c40f;
            color: #7f5600;
            font-size: 8.5pt;
            font-weight: 700;
            padding: 3px 7px;
            border-radius: 999px;
        }
        .mission-card.is-complete {
            border-color: #1c7c4c;
            box-shadow: 0 0 0 3px rgba(28,124,76,0.2);
        }
        .mission-card.is-complete::before {
            content: 'Concluida';
            position: absolute;
            left: 10px;
            top: 10px;
            background: #eafaf1;
            border: 1px solid #2ecc71;
            color: #1c7c4c;
            font-size: 8.5pt;
            font-weight: 700;
            padding: 3px 7px;
            border-radius: 999px;
        }
        .mission-title {
            font-weight: 800;
            color: #1a5276;
            margin-bottom: 6px;
        }
        .mission-tag {
            display: inline-block;
            font-size: 9pt;
            padding: 3px 8px;
            border-radius: 999px;
            background: #e8f4ff;
            color: #1a5276;
            font-weight: 700;
        }
        .badge-row { margin-top: 8px; }
        .badge {
            display: inline-block;
            margin-right: 6px;
            padding: 4px 8px;
            border-radius: 8px;
            background: #f1c40f;
            color: #7f5600;
            font-weight: 700;
            font-size: 9pt;
        }
        .cta-button {
            display: inline-block;
            margin-top: 8px;
            background: #2ecc71;
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 10pt;
            animation: pulse 2s ease-in-out infinite;
        }
        .cta-button:hover {
            filter: brightness(0.94);
        }
        a.cta-button {
            text-decoration: none;
        }
        .learning-hud {
            position: sticky;
            top: 10px;
            z-index: 30;
            margin: 0 0 14px 0;
            border: 2px solid #b8d9f5;
            border-radius: 12px;
            background: #f7fbff;
            padding: 10px 12px;
        }
        .hud-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }
        .hud-pill {
            border-radius: 999px;
            padding: 4px 10px;
            background: #e8f4ff;
            color: #1a5276;
            font-size: 9.5pt;
            font-weight: 700;
        }
        .mode-switch {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }
        .student-controls {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            padding: 8px;
            border-radius: 10px;
            background: linear-gradient(135deg, #fff7dd, #fff0f5);
            border: 2px solid #ffd166;
        }
        .age-select {
            border: 2px solid #ff9f1c;
            background: #fffaf0;
            color: #6a3906;
            border-radius: 8px;
            padding: 6px 8px;
            font-size: 9.5pt;
            font-weight: 700;
            min-height: 38px;
        }
        .prof-checklist {
            border: 2px solid #b8d9f5;
            border-radius: 12px;
            background: #f7fbff;
            padding: 12px;
            margin: 10px 0 18px 0;
        }
        .prof-checklist-item {
            display: flex;
            gap: 8px;
            align-items: center;
            margin: 6px 0;
            font-size: 10pt;
        }
        .presentation-controls {
            margin-top: 8px;
            display: none;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }
        .mode-label {
            font-size: 9.5pt;
            color: #1a5276;
            font-weight: 700;
        }
        .mode-btn {
            border: 2px solid #ff9f1c;
            background: linear-gradient(180deg, #fff9e8, #ffe8cc);
            color: #6a3906;
            border-radius: 999px;
            padding: 7px 12px;
            font-size: 9pt;
            font-weight: 700;
            cursor: pointer;
            min-height: 38px;
        }
        .mode-btn.active {
            border-color: #ff7f11;
            background: linear-gradient(180deg, #fff1e0, #ffd9b5);
            color: #8a2e00;
        }
        #complete-stage-btn {
            border-color: #00b894;
            background: linear-gradient(180deg, #e9fff8, #c6ffe8);
            color: #005640;
            box-shadow: 0 0 0 3px rgba(0,184,148,0.22);
        }
        #back-stage-btn {
            border-color: #6ac4ff;
            background: linear-gradient(180deg, #f0fbff, #dff5ff);
            color: #0e4668;
        }
        #reset-progress-btn {
            border-color: #ff6b6b;
            background: linear-gradient(180deg, #fff2f2, #ffdede);
            color: #8a1f1f;
        }
        .module-focus {
            margin: 10px 0 12px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .focus-chip {
            border: 2px solid #6ac4ff;
            background: linear-gradient(180deg, #f0fbff, #def6ff);
            color: #0e4668;
            font-weight: 700;
            border-radius: 999px;
            padding: 7px 12px;
            cursor: pointer;
            min-height: 38px;
        }
        .focus-chip.active {
            border-color: #00b894;
            background: linear-gradient(180deg, #e7fff7, #c6ffe8);
            color: #005640;
            box-shadow: 0 0 0 3px rgba(0,184,148,0.2);
        }
        .hidden-by-focus {
            display: none !important;
        }
        .quest-box {
            border: 2px dashed #b8d9f5;
            background: #f7f9fb;
            border-radius: 12px;
            padding: 12px;
            margin: 12px 0;
        }
        .lesson-card.active-lesson {
            border-color: #2ecc71;
            box-shadow: 0 0 0 3px rgba(46,204,113,0.2);
            background: #f8fff9;
        }
        .presentation-hidden {
            display: none !important;
        }
        .student-single-hidden {
            display: none !important;
        }
        body.mode-professor .sparkle,
        body.mode-professor .progress-track,
        body.mode-professor .badge-row,
        body.mode-professor .module-caption {
            display: none !important;
        }
        body.mode-professor .mission-card:not(.is-active),
        body.mode-professor .lesson-card:not(.active-lesson),
        body.mode-apresentacao .mission-card:not(.is-active),
        body.mode-apresentacao .lesson-card:not(.active-lesson) {
            display: none !important;
        }
        body.mode-professor .mission-card.is-active,
        body.mode-professor .lesson-card.active-lesson,
        body.mode-apresentacao .mission-card.is-active,
        body.mode-apresentacao .lesson-card.active-lesson {
            display: block !important;
        }
        body.mode-apresentacao nav {
            display: none !important;
        }
        body.mode-apresentacao {
            background: #ffffff !important;
            color: #111 !important;
        }
        body.mode-apresentacao main {
            margin-left: 0;
            padding: 20px 28px 34px 28px;
            max-width: 1100px;
        }
        body.mode-apresentacao .learning-hud {
            background: #ffffff;
            border-color: #1f4f77;
            box-shadow: 0 4px 14px rgba(0,0,0,0.08);
        }
        body.mode-apresentacao .hud-pill {
            background: #f0f6ff;
            color: #0e3a5b;
            border: 1px solid #bfd8f3;
        }
        body.mode-apresentacao .mode-btn,
        body.mode-apresentacao .focus-chip {
            border-color: #7aaad6;
            color: #0e3a5b;
        }
        body.mode-apresentacao .mode-btn.active,
        body.mode-apresentacao .focus-chip.active {
            border-color: #1c7c4c;
            background: #eafaf1;
            color: #1c7c4c;
        }
        body.mode-apresentacao .indice-box,
        body.mode-apresentacao .start-steps,
        body.mode-apresentacao .roadmap-panel,
        body.mode-apresentacao .module-focus,
        body.mode-apresentacao #lesson-hint,
        body.mode-apresentacao .quest-box,
        body.mode-apresentacao .game-hero {
            display: none !important;
        }
        body.mode-aluno h1#aulas,
        body.mode-aluno h1#aulas + .lesson-content {
            display: none !important;
        }
        body.mode-aluno nav a[href="#aulas"],
        body.mode-aluno .indice-list a[href="#aulas"] {
            display: none !important;
        }
        .nav-link-locked {
            opacity: 0.45;
            pointer-events: none;
        }
        body.mode-apresentacao .presentation-controls {
            display: flex;
        }
        body.mode-apresentacao .header-banner {
            padding: 18px 22px;
            background: linear-gradient(135deg, #0f4e79, #246ea0);
        }
        body.mode-apresentacao .hud-pill {
            font-size: 10.5pt;
        }
        body.mode-apresentacao h1 {
            font-size: 26pt;
        }
        body.mode-apresentacao h2 {
            color: #0f4e79;
        }
        body.mode-apresentacao pre,
        body.mode-apresentacao .diagram {
            background: #f8fbff;
            border-color: #7aaad6;
            color: #0d2233;
        }
        body.mode-apresentacao .mission-card.is-active,
        body.mode-apresentacao .lesson-card.active-lesson {
            border-color: #1f4f77;
            box-shadow: 0 0 0 4px rgba(31,79,119,0.18);
            background: #ffffff;
        }
        .quick-exit {
            display: none;
            position: fixed;
            right: 16px;
            bottom: 16px;
            z-index: 90;
        }
        .quick-exit .mode-btn {
            min-width: 210px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.2);
            border-color: #1c7c4c;
            background: #1c7c4c;
            color: #fff;
        }
        body.mode-apresentacao .quick-exit {
            display: block;
        }
        .student-slide-hidden {
            display: none !important;
        }
        .student-slide-group {
            margin-bottom: 14px;
        }
        .student-flow-anchor {
            border: 2px solid #ffd166;
            border-radius: 10px;
            background: linear-gradient(180deg, #fff9e6, #fff1cc);
            color: #7a4b00;
            font-size: 9.5pt;
            font-weight: 800;
            padding: 8px 10px;
            margin-bottom: 10px;
        }
        .student-step-nav {
            display: none;
            position: fixed;
            left: calc(var(--layout-sidebar-offset) + ((100% - var(--layout-sidebar-offset)) * 0.5));
            transform: translateX(-50%);
            bottom: 12px;
            z-index: 96;
            width: fit-content;
            min-width: 230px;
            max-width: 100%;
            border: 2px solid #6ac4ff;
            border-radius: 14px;
            background: linear-gradient(180deg, #f8feff, #e8f8ff);
            box-shadow: 0 6px 14px rgba(14,70,104,0.14);
            padding: 10px;
            align-items: center;
            justify-content: center;
        }
        .student-step-nav .step-btn {
            border: 2px solid #6ac4ff;
            background: linear-gradient(180deg, #f0fbff, #dff5ff);
            color: #0e4668;
            border-radius: 11px;
            padding: 10px 12px;
            font-size: 10pt;
            font-weight: 800;
            cursor: pointer;
            min-width: 130px;
        }
        .student-step-nav .step-btn:disabled {
            opacity: 0.45;
            cursor: not-allowed;
        }
        .student-step-nav .step-btn-next {
            border-color: #00b86b;
            background: linear-gradient(180deg, #e8ffef, #c9ffe0);
            color: #005c35;
            box-shadow: 0 0 0 3px rgba(0,184,107,0.18);
        }
        .student-step-label {
            font-size: 9.8pt;
            color: #0e4668;
            font-weight: 800;
            text-align: center;
            display: block;
        }
        body.mode-aluno .learning-hud {
            position: static;
        }
        body.mode-professor .learning-hud,
        body.mode-apresentacao .learning-hud {
            position: static;
        }
        body.mode-aluno .student-step-nav {
            display: flex;
        }
        body.mode-aluno main {
            padding-bottom: 96px;
        }
        body.mode-professor .student-step-nav,
        body.mode-apresentacao .student-step-nav {
            display: none !important;
        }
        .student-fab-nav {
            display: none;
            position: fixed;
            right: 16px;
            bottom: 14px;
            z-index: 98;
            gap: 10px;
            align-items: center;
        }
        .student-fab-btn {
            width: 68px;
            height: 68px;
            border-radius: 50%;
            border: 3px solid #d0d7de;
            background: #ffffff;
            color: #1f2937;
            font-size: 28px;
            font-weight: 900;
            cursor: pointer;
            box-shadow: 0 10px 24px rgba(0,0,0,0.2);
            line-height: 1;
        }
        .student-fab-prev {
            border-color: #ff6b6b;
            background: linear-gradient(180deg, #ffe9e9, #ffd4d4);
            color: #7f1d1d;
        }
        .student-fab-next {
            border-color: #27ae60;
            background: linear-gradient(180deg, #e9ffe9, #cbffd6);
            color: #065f46;
        }
        .student-fab-btn:disabled,
        .student-fab-next.is-read-locked {
            border-color: #a3a3a3;
            background: linear-gradient(180deg, #efefef, #d9d9d9);
            color: #616161;
            cursor: not-allowed;
            box-shadow: 0 6px 14px rgba(0,0,0,0.18);
        }
        body.mode-aluno .student-fab-nav {
            display: flex;
        }
        body.mode-professor .student-fab-nav,
        body.mode-apresentacao .student-fab-nav {
            display: none !important;
        }
        .quest-title {
            font-weight: 800;
            color: #2c6fb3;
        }
        .robot-dialog-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(10, 38, 59, 0.65);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 120;
            padding: 14px;
        }
        .robot-dialog-backdrop[hidden] {
            display: none;
        }
        .robot-dialog {
            width: min(520px, 100%);
            border: 3px solid #ffbe55;
            border-radius: 16px;
            background: linear-gradient(180deg, #fffdf7, #fff5e5);
            box-shadow: 0 18px 36px rgba(0,0,0,0.25);
            padding: 14px;
        }
        .robot-dialog h3 {
            margin: 0 0 8px 0;
            color: #8a2e00;
        }
        .robot-dialog p {
            margin: 6px 0;
            color: #5f3000;
            font-weight: 600;
        }
        .robot-dialog-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.95; }
            50% { transform: scale(1.03); opacity: 1; }
            100% { transform: scale(1); opacity: 0.95; }
        }
        @keyframes float {
            0% { transform: translateY(0); }
            50% { transform: translateY(6px); }
            100% { transform: translateY(0); }
        }
        @media (prefers-reduced-motion: reduce) {
            .progress-fill,
            .cta-button,
            .game-hero .sparkle {
                animation: none !important;
            }
            .mission-card {
                transition: none !important;
            }
        }
    
        @media print {
            nav { display: none; }
            main { margin-left: 0; }
            h1 { page-break-before: always; }
            h1:first-of-type { page-break-before: avoid; }
            .box, pre { page-break-inside: avoid; }
        }
        @media (max-width: 900px) {
            nav { display: none; }
            :root { --layout-sidebar-offset: 0px; }
            main { margin-left: 0; padding: 14px; }
            .learning-hud {
                top: 6px;
                padding: 10px;
            }
            .hud-row,
            .mode-switch,
            .module-focus {
                gap: 6px;
            }
            .hud-pill {
                font-size: 9pt;
                padding: 4px 8px;
            }
            .mode-btn,
            .focus-chip,
            .cta-button {
                width: 100%;
                text-align: center;
                min-height: 40px;
            }
            .mission-grid {
                grid-template-columns: 1fr;
            }
            .start-steps {
                grid-template-columns: 1fr;
            }
            .indice-list {
                columns: 1;
            }
            .game-hero {
                padding: 18px;
                margin-bottom: 14px;
            }
            body.mode-apresentacao main {
                padding: 12px;
            }
            body.mode-apresentacao .learning-hud {
                top: 4px;
            }
            .quick-exit {
                right: 10px;
                left: 10px;
                bottom: 10px;
            }
            .quick-exit .mode-btn {
                width: 100%;
            }
            .student-step-nav {
                width: 100%;
                max-width: calc(100% - 14px);
                left: 50%;
                padding: 8px;
                gap: 6px;
                bottom: 6px;
            }
            .student-step-nav .step-btn {
                min-width: 88px;
                padding: 9px 8px;
                font-size: 9.4pt;
            }
            .student-step-label {
                font-size: 9pt;
                line-height: 1.25;
            }
            .student-fab-nav {
                right: 10px;
                bottom: 10px;
                gap: 8px;
            }
            .student-fab-btn {
                width: 58px;
                height: 58px;
                font-size: 24px;
            }
            body.mode-aluno main {
                padding-bottom: 90px;
            }
        }
    </style>
</head>
<body>

<nav>
    <h2>INDICE</h2>
            <a href="#mapa-jogo">0. Mapa do Jogo</a>
<a href="#aulas">0. Aulas por Etapas</a>
<a href="#intro">1. Introducao</a>
    <a href="#hardware">2. Hardware</a>
    <a href="#sinais">3. Sinais LED</a>
    <a href="#primeiros-passos">4. Primeiros Passos</a>
    <a href="#ligar-robo">4A. Como Ligar o Robo (Bateria + ID)</a>
    <a href="#movimento">5. Comandos Movimento</a>
    <a href="#led">6. Comandos LED</a>
    <a href="#servo">7. Comandos Servo</a>
    <a href="#buzzer">8. Comando Buzzer</a>
    <a href="#linha">9. Sensor de Linha</a>
    <a href="#ultra">10. Sensor Ultrassonico (sensor de distancia)</a>
    <a href="#controle">11. Estruturas de Controle</a>
    <a href="#condicoes">12. Condicoes SE</a>
    <a href="#calibracao">13. Calibracao Motores</a>
    <a href="#velocidades">14. Velocidades (Upgrade 5.2)</a>
    <a href="#referencia">15. Referencia Rapida</a>
    <a href="#exemplos">16. Exemplos Praticos</a>
    <a href="#problemas">17. Resolucao Problemas</a>
    <a href="#upgrade52">18. Upgrade 5.2</a>
    <a href="#glossario">19. Glossario</a>
</nav>

<main>
    <div class="header-banner">
        <h1>MOSTRABOT 5em1 v5.1</h1>
        <p>Apostila Completa para Professores - EJR Robotica Educacional</p>
        <p style="font-size:10pt; margin-top:20px;">Plataforma Jabuti Edu (PJE) | Janeiro 2026</p>
    </div>

    <!-- INDICE NO CORPO (para PDF) -->
    <div class="indice-box" id="indice">
        <div class="indice-title">INDICE</div>
        <ul class="indice-list">
                                    <li><a href="#mapa-jogo">0. Mapa do Jogo</a></li>
<li><a href="#aulas">0. Aulas por Etapas</a></li>
<li><a href="#intro">1. Introducao</a></li>
            <li><a href="#hardware">2. Hardware</a></li>
            <li><a href="#sinais">3. Sinais LED</a></li>
            <li><a href="#primeiros-passos">4. Primeiros Passos</a></li>
            <li><a href="#ligar-robo">4A. Como Ligar o Robo (Bateria + ID)</a></li>
            <li><a href="#movimento">5. Comandos Movimento</a></li>
            <li><a href="#led">6. Comandos LED</a></li>
            <li><a href="#servo">7. Comandos Servo</a></li>
            <li><a href="#buzzer">8. Comando Buzzer</a></li>
            <li><a href="#linha">9. Sensor de Linha</a></li>
            <li><a href="#ultra">10. Sensor Ultrassonico (sensor de distancia)</a></li>
            <li><a href="#controle">11. Estruturas de Controle</a></li>
            <li><a href="#condicoes">12. Condicoes SE</a></li>
            <li><a href="#calibracao">13. Calibracao Motores</a></li>
            <li><a href="#velocidades">14. Velocidades (Upgrade 5.2)</a></li>
            <li><a href="#referencia">15. Referencia Rapida</a></li>
            <li><a href="#exemplos">16. Exemplos Praticos</a></li>
            <li><a href="#problemas">17. Resolucao Problemas</a></li>
            <li><a href="#upgrade52">18. Upgrade 5.2</a></li>
            <li><a href="#glossario">19. Glossario</a></li>
        </ul>
    </div>

    <h1 id="mapa-jogo">0. Mapa do Jogo (Apostila Gamificada)</h1>

    <div class="game-hero">
        <div class="sparkle"></div>
        <h2>Missões do MostraBot</h2>
        <p>O professor guia as crianças como um jogo por fases. Cada missão tem um objetivo simples.</p>
        <p><strong>Meta:</strong> completar as missões e ganhar selos.</p>
        <div class="progress-track"><div class="progress-fill"></div></div>
    </div>
    <div class="learning-hud" id="learning-hud">
        <div class="hud-row">
            <span class="hud-pill">Missao atual: <span id="hud-missao">Missao 0</span></span>
            <span class="hud-pill">Aula atual: <span id="hud-aula">Aula 1</span></span>
            <span class="hud-pill">Modulo atual: <span id="hud-modulo">Modulo 1</span></span>
            <span class="hud-pill">Secao: <span id="hud-secao">Mapa do Jogo</span></span>
            <span class="hud-pill">Atalhos: A | P | D</span>
        </div>
        <div class="start-steps">
            <section class="step-panel">
                <span class="step-kicker">Etapa 1</span>
                <h3>Toque no MostraBot</h3>
                <p>Clique no robô para abrir orientações curtas e tranquilas.</p>
                <button class="robot-guide-btn" type="button" id="robot-guide-trigger">
                    <img class="robot-hero-img" src="assets_lessons/mostrabot-padrao.png" alt="MostraBot guia da missão">
                    <span>Oi! Clique em mim para receber a dica da fase.</span>
                </button>
            </section>
            <section class="step-panel">
                <span class="step-kicker">Etapa 2</span>
                <h3>Escolha o modo</h3>
                <p>Professor vê tudo. Aluno avança fase por fase.</p>
                <div class="mode-switch" id="mode-switch">
                    <button class="mode-btn active" type="button" data-mode="aluno">Modo Aluno</button>
                    <button class="mode-btn" type="button" data-mode="professor">Modo Professor</button>
                    <button class="mode-btn" type="button" data-mode="apresentacao">Modo Apresentacao</button>
                    <span class="hud-pill">Modo atual: <span id="hud-modo">Aluno</span></span>
                </div>
            </section>
            <section class="step-panel">
                <span class="step-kicker">Etapa 3</span>
                <h3>Controle de avanço</h3>
                <p>Complete tarefas para liberar a próxima fase.</p>
                <div class="student-controls" id="student-controls">
                    <span class="mode-label">Faixa etaria (Aluno):</span>
                    <select class="age-select" id="age-select">
                        <option value="6-8">6-8 anos</option>
                        <option value="9-11" selected>9-11 anos</option>
                        <option value="12-14">12-14 anos</option>
                        <option value="15+">15+ anos</option>
                    </select>
                    <button class="mode-btn" type="button" id="back-stage-btn">Voltar 1 fase</button>
                    <button class="mode-btn" type="button" id="complete-stage-btn">Completar fase atual</button>
                    <button class="mode-btn" type="button" id="reset-progress-btn">Resetar progresso</button>
                    <span class="hud-pill">Fase liberada: <span id="hud-unlock">0</span>/6</span>
                    <span class="hud-pill">Missoes concluidas: <span id="hud-completed">0</span>/7</span>
                </div>
                <div class="presentation-controls" id="presentation-controls">
                    <span class="mode-label">Etapas guiadas:</span>
                    <button class="mode-btn" type="button" data-stage-nav="prev">Etapa Anterior</button>
                    <button class="mode-btn" type="button" data-stage-nav="next">Proxima Etapa</button>
                    <span class="hud-pill">Atalho: ← / → | Esc</span>
                </div>
            </section>
        </div>
    </div>
    <details class="roadmap-panel">
        <summary>Abrir MAPA do progresso</summary>
        <div class="roadmap-content">
    <div class="module-focus" id="module-focus">
        <button class="focus-chip active" type="button" data-focus="all">Ver Tudo</button>
        <button class="focus-chip" type="button" data-focus="m1">Foco Modulo 1</button>
        <button class="focus-chip" type="button" data-focus="m2">Foco Modulo 2</button>
        <button class="focus-chip" type="button" data-focus="m4">Foco Modulo 4</button>
        <button class="focus-chip" type="button" data-focus="support">Foco Suporte</button>
    </div>

    <div class="mission-grid">
        <div class="mission-card" data-target="intro" data-module="m1" data-order="0" data-mission="Missao 0">
            <div class="mission-title">Missão 0 — Quem é o MostraBot</div>
            <span class="mission-tag">Boas-vindas</span>
            <div class="badge-row"><span class="badge">Selo: Explorador</span></div>
            <a class="cta-button" href="#intro">Comecar</a>
        </div>
        <div class="mission-card" data-target="ligar-robo" data-module="m1" data-order="1" data-mission="Missao 1">
            <div class="mission-title">Missão 1 — Ligar e Entrar na PJE</div>
            <span class="mission-tag">Energia + Login</span>
            <div class="badge-row"><span class="badge">Selo: Energia</span></div>
            <a class="cta-button" href="#ligar-robo">Jogar</a>
        </div>
        <div class="mission-card" data-target="led" data-module="m1" data-order="2" data-mission="Missao 2">
            <div class="mission-title">Missão 2 — Acender LED</div>
            <span class="mission-tag">Modulo 1</span>
            <div class="badge-row"><span class="badge">Selo: Luz</span></div>
            <a class="cta-button" href="#led">Jogar</a>
        </div>
        <div class="mission-card" data-target="movimento" data-module="m1" data-order="3" data-mission="Missao 3">
            <div class="mission-title">Missão 3 — Ir para Frente</div>
            <span class="mission-tag">Modulo 1</span>
            <div class="badge-row"><span class="badge">Selo: Direcao</span></div>
            <a class="cta-button" href="#movimento">Jogar</a>
        </div>
        <div class="mission-card" data-target="buzzer" data-module="m1 m2" data-order="4" data-mission="Missao 4">
            <div class="mission-title">Missão 4 — Buzinar</div>
            <span class="mission-tag">Som</span>
            <div class="badge-row"><span class="badge">Selo: Som</span></div>
            <a class="cta-button" href="#buzzer">Jogar</a>
        </div>
        <div class="mission-card" data-target="servo" data-module="m2" data-order="5" data-mission="Missao 5">
            <div class="mission-title">Missão 5 — Programar no Modulo 2</div>
            <span class="mission-tag">Codigo</span>
            <div class="badge-row"><span class="badge">Selo: Codigo</span></div>
            <a class="cta-button" href="#servo">Jogar</a>
        </div>
        <div class="mission-card" data-target="linha" data-module="m4" data-order="6" data-mission="Missao 6">
            <div class="mission-title">Missão 6 — Sensores e Decisao</div>
            <span class="mission-tag">Modulo 4</span>
            <div class="badge-row"><span class="badge">Selo: Mestre</span></div>
            <a class="cta-button" href="#linha">Jogar</a>
        </div>
    </div>

    <div class="quest-box">
        <div class="quest-title">Regra do Jogo</div>
        <p>Somente avance quando a turma concluir a missão anterior. Isso evita confusão.</p>
    </div>
    <div class="mascot-strip">
        <div class="mascot-card">
            <img src="assets_lessons/mostrabot-padrao.png" alt="MostraBot sorrindo">
            <div class="mascot-title">MostraBot Feliz :)</div>
            <div class="mascot-text">"Vamos com calma. Voce consegue!"</div>
        </div>
        <div class="mascot-card">
            <img src="assets_lessons/mostrabot-padrao.png" alt="MostraBot em desafio">
            <div class="mascot-title">MostraBot Desafio !</div>
            <div class="mascot-text">"Hora da tarefa: um passo por vez."</div>
        </div>
        <div class="mascot-card">
            <img src="assets_lessons/mostrabot-padrao.png" alt="MostraBot conquista">
            <div class="mascot-title">MostraBot Vitoria *</div>
            <div class="mascot-text">"Missao concluida! Novo selo desbloqueado."</div>
        </div>
    </div>
        </div>
    </details>
    <div class="box box-info">
        <h3>Sinalizacoes de tranquilidade</h3>
        <p><strong>Verde:</strong> pode seguir. <strong>Amarelo:</strong> revisar com calma. <strong>Azul:</strong> dica de apoio. O foco e aprender com confianca, passo a passo.</p>
    </div>
    <!-- SECAO 1 -->
    
    <!-- SECAO AULAS -->
    
    <h1 id="aulas">0. Plano do Professor (aulas por etapas)</h1>
    <p>Visivel no modo Professor. O aluno segue as missoes guiadas; este bloco e para planejamento docente.</p>
    <div class="prof-checklist" id="prof-checklist">
        <h3>Checklist rapido do professor</h3>
        <div id="prof-checklist-items"></div>
    </div>

    <div class="lesson-card" id="aula-1" data-module="m1" data-aula="Aula 1">
        <div class="lesson-title">Módulo 1 — Aula 1: Ligar e Entrar na PJE</div>
        <div class="lesson-goal">Objetivo: ligar o robô, identificar o ID e entrar na PJE.</div>
        <img class="module-img didactic-img" src="assets_lessons/01_ligar_robo.svg" alt="Ligar e entrar">
        <div class="module-caption">Cabo branco + LED + PJE</div>
    </div>

    <div class="lesson-card" id="aula-2" data-module="m1" data-aula="Aula 2">
        <div class="lesson-title">Módulo 1 — Aula 2: Movimentos Básicos</div>
        <div class="lesson-goal">Objetivo: PF, PT, PD, PE com tempos curtos.</div>
        <img class="module-img didactic-img" src="assets_lessons/02_trajeto_quadrado.svg" alt="Quadrado seguro">
        <div class="module-caption">Exercício guiado: quadrado seguro</div>
    </div>

    <div class="lesson-card" id="aula-3" data-module="m1" data-aula="Aula 3">
        <div class="lesson-title">Módulo 1 — Aula 3: LEDs (Feedback)</div>
        <div class="lesson-goal">Objetivo: usar LEDs como resposta visual.</div>
        <img class="module-img didactic-img" src="assets_lessons/04_led_feedback.svg" alt="Movimento com LED">
        <div class="module-caption">Movimento + LED</div>
    </div>

    <div class="lesson-card" id="aula-4" data-module="m2" data-aula="Aula 4">
        <div class="lesson-title">Módulo 2 — Aula 4: Programação com Texto</div>
        <div class="lesson-goal">Objetivo: digitar comandos no Módulo 2 e testar.</div>
        <img class="module-img didactic-img" src="assets_lessons/03_trajeto_zigzag.svg" alt="Zigue-zague">
        <div class="module-caption">Desafio: zigue-zague com tempos curtos</div>
    </div>

    <div class="lesson-card" id="aula-5" data-module="m2" data-aula="Aula 5">
        <div class="lesson-title">Módulo 2 — Aula 5: Garra e Som</div>
        <div class="lesson-goal">Objetivo: usar garra e buzzer em sequência.</div>
        <img class="module-img didactic-img" src="assets_lessons/05_garra_pegar.svg" alt="Pegar objeto">
        <div class="module-caption">Abrir/fechar garra com som</div>
    </div>

    <div class="lesson-card" id="aula-6" data-module="m4" data-aula="Aula 6">
        <div class="lesson-title">Módulo 4 — Aula 6: REPITA e SE</div>
        <div class="lesson-goal">Objetivo: repetir movimentos e reagir a condições.</div>
        <img class="module-img didactic-img" src="assets_lessons/08_repita_trajeto.svg" alt="Repita voltas">
        <div class="module-caption">Repita 4 voltas no quadrado</div>
        <img class="module-img didactic-img" src="assets_lessons/09_se_reacao.svg" alt="Se detectar, pare">
        <div class="module-caption">Se detectar obstáculo, reaja</div>
    </div>

    <div class="lesson-card" id="aula-7" data-module="m4" data-aula="Aula 7">
        <div class="lesson-title">Sensor de Linha — Aula 7</div>
        <div class="lesson-goal">Objetivo: seguir a linha no chão.</div>
        <img class="module-img didactic-img" src="assets_lessons/06_linha.svg" alt="Seguir linha">
        <div class="module-caption">Pista simples para seguir</div>
    </div>

    <div class="lesson-card" id="aula-8" data-module="m4" data-aula="Aula 8">
        <div class="lesson-title">Sensor Ultrassônico — Aula 8</div>
        <div class="lesson-goal">Objetivo: desviar de obstáculos automaticamente.</div>
        <img class="module-img didactic-img" src="assets_lessons/07_ultra_desvio.svg" alt="Desvio de obstaculos">
        <div class="module-caption">Obstáculo na frente, o robô desvia</div>
    </div>

    <div class="lesson-card" id="aula-9" data-module="support" data-aula="Aula 9">
        <div class="lesson-title">Atualizar Firmware — Aula 9</div>
        <div class="lesson-goal">Objetivo: atualizar o programa do robô com segurança.</div>
        <div class="box box-info">
            <p><strong>Video:</strong> (inserir link do video aqui)</p>
        </div>
        <p>Passo a passo será explicado no video. Após assistir, o professor repete o processo com os alunos.</p>
    </div>
<h1 id="intro">1. Introducao ao MostraBot</h1>

    <div class="box box-success">
        <h3>Voce consegue!</h3>
        <p>Esta apostila foi feita para deixar a aula leve. Use as imagens, leia devagar e siga as etapas. O robo foi feito para aprender brincando.</p>
    </div>

    <div class="mission-header">
        <div>
            <div class="mission-name">Missao: Conhecer o Robo</div>
            <div class="mission-goal">Objetivo: Saber o que e e para que serve</div>
            <div class="mission-reward">Selo: Explorador</div>
        </div>
        <div class="mission-badges"><span class="mission-badge">Boas-vindas</span></div>
    </div>

    <h2>O que e o MostraBot?</h2>
    <img class="module-img didactic-img" src="assets_full/01_intro_robo.png" alt="Mostrabot - robo educacional">
    <div class="module-caption">O Mostrabot e um robo educacional para sala de aula</div>
    <p>O <strong>MostraBot</strong> e um robo educacional desenvolvido pela <strong>EJR Robotica Educacional</strong> especialmente para uso em salas de aula. Ele foi projetado para ensinar programacao e robotica de forma progressiva, do mais simples ao mais complexo.</p>

    <h2>A Plataforma PJE Nuvem</h2>
    <p>O MostraBot funciona conectado a <strong>Plataforma Jabuti Edu (PJE) Nuvem</strong>:</p>
    <div class="diagram">
   PROFESSOR/ALUNO                        MOSTRABOT
   +--------------+                       +--------------+
   |   Digita     |    Internet           |   Executa    |
   |  comandos    | --------------------> |   comandos   |
   |   na PJE     |                       |  no robo     |
   +--------------+                       +--------------+
         |                                     ^
         v                                     |
   +--------------+                            |
   |  PJE NUVEM   |----------------------------+
   |  (servidor)  |       WiFi
   +--------------+
    </div>
    <p>O professor e o aluno programam pela PJE no navegador, e o robo executa automaticamente!</p>

    <h2>Como Funcionam os Modulos da PJE (Visao Rapida)</h2>
    <img class="module-img didactic-img" src="mod1.png" alt="Modulo 1 da PJE">
    <div class="module-caption">Modulo 1 (botoes prontos)</div>
    <img class="module-img didactic-img" src="mod2.png" alt="Modulo 2 da PJE">
    <div class="module-caption">Modulo 2 (cliques guiados com tempo t e ms)</div>
    <img class="module-img didactic-img" src="mod4.png" alt="Modulo 4 da PJE">
    <div class="module-caption">Modulo 4 (sensores e logica)</div>
    <ul>
        <li><strong>Modulo 1:</strong> e o mais automatico. O aluno usa botoes prontos e escolhe o tempo no select.</li>
        <li><strong>Modulo 2:</strong> ainda e por cliques. O aluno monta comandos semi-prontos no campo, escolhendo <code>t</code> e milissegundos para cada acao. Nas primeiras etapas ele nao precisa digitar no teclado.</li>
        <li><strong>Modulo 4:</strong> e o mais avancado. Aqui o aluno faz tudo manualmente no campo de texto, sem depender dos cliques do mouse, usando sensores e logica (<code>sensor</code>, <code>repita</code>, <code>se</code>).</li>
    </ul>
    <div class="mission-task">
        <div class="mission-task-title">Fluxo real da PJE (acesso externo em nuvem)</div>
        <ol>
            <li>Clique em <strong>Programar</strong> no menu do topo da PJE.
                <div class="task-visual"><img src="pje-programar.png" alt="Passo 1 da PJE: clicar em Programar"></div>
                <div class="task-visual"><img src="assets_lessons/11_pje_menu_programar.svg" alt="Passo 1 vetorizado: clicar em Programar"></div>
            </li>
            <li>No login, use o <strong>ID da fita amarela da bateria</strong>, senha <strong>123</strong> e na caixa de selecao escolha o <strong>modulo da missao</strong> (1, 2 ou 4).
                <div class="task-visual"><img src="login_pje.png" alt="Passo 2 da PJE: login com ID, senha e modulo"></div>
                <div class="task-visual"><img src="assets_lessons/12_pje_login_id_senha.svg" alt="Passo 2 vetorizado: login com ID, senha e modulo"></div>
            </li>
            <li>Clique em <strong>Entrar</strong> para abrir o modulo selecionado e faca 3 exercicios de validacao no <strong>Modulo 1</strong>:
                <br>1) acender LED direito (<strong>LD</strong>)
                <br>2) acender LED esquerdo (<strong>LE</strong>)
                <br>3) buzinar (<strong>BU</strong>)
                <div class="task-visual"><img src="mod1.png" alt="Passo 3 da PJE: abrir o modulo selecionado"></div>
                <div class="task-visual"><img src="assets_full/06_led_botoes.png" alt="Passo 3 da PJE: exercicios LD LE BU no modulo 1"></div>
                <div class="task-visual"><img src="assets_lessons/13_pje_modulo_missao.svg" alt="Passo 3 vetorizado: escolher modulo da missao"></div>
            </li>
            <li>Confirme que os 3 testes funcionaram no robo e finalize a tarefa.</li>
        </ol>
        <div class="robot-signal-card">
            <div class="robot-signal-title">Sinais que o robo deve mostrar nesta fase</div>
            <div class="robot-signal-figure">
                <img src="assets_lessons/mostrabot-padrao.png" alt="MostraBot com marcacoes visuais dos sinais esperados">
                <span class="signal-dot signal-led-dir" aria-hidden="true"></span>
                <span class="signal-dot signal-led-esq" aria-hidden="true"></span>
                <span class="signal-dot signal-buzzer" aria-hidden="true"></span>
                <span class="signal-tag tag-led-dir">LED direito (LD)</span>
                <span class="signal-tag tag-led-esq">LED esquerdo (LE)</span>
                <span class="signal-tag tag-buzzer">Buzzer (BU)</span>
            </div>
            <p><strong>Valide:</strong> LD acende, LE acende e BU emite som.</p>
            <div id="awake-status-msg" class="awake-status locked">Mensagem final liberada apos concluir a proxima missao: <strong>Ligar o Robo</strong>.</div>
        </div>
        <table>
            <tr><th>Modulo</th><th>Como o aluno interage</th><th>Foco pedagogico</th></tr>
            <tr><td>Modulo 1</td><td>Clique em botoes e setas</td><td>Direcao e causa-efeito</td></tr>
            <tr><td>Modulo 2</td><td>Cliques guiados e comandos semi-prontos com tempo (t e ms)</td><td>Sequencia e previsao</td></tr>
            <tr><td>Modulo 4</td><td>Comandos manuais completos + sensores + condicoes</td><td>Autonomia e tomada de decisao</td></tr>
        </table>
        <p><strong>Acesso externo (PJE online):</strong></p>
        <div class="cloud-links">
            <a class="cloud-link" href="https://pje.ejrrobotica.com.br/index.php" target="_blank" rel="noopener noreferrer">Login</a>
            <a class="cloud-link" href="https://pje.ejrrobotica.com.br/modulo1.php" target="_blank" rel="noopener noreferrer">Modulo 1</a>
            <a class="cloud-link" href="https://pje.ejrrobotica.com.br/modulo2.php" target="_blank" rel="noopener noreferrer">Modulo 2</a>
            <a class="cloud-link" href="https://pje.ejrrobotica.com.br/modulo4.php" target="_blank" rel="noopener noreferrer">Modulo 4</a>
        </div>
        <p class="external-hint">Os links da PJE abrem em nova aba para voce nao perder esta trilha.</p>
        <p><strong>Regra didatica simples:</strong> no Modulo 1 voce clica. No Modulo 2 ainda e guiado por cliques/semi-pronto. No Modulo 4 a escrita e manual.</p>
        <img class="module-img" src="modulos.png" alt="Layout dos Modulos 1, 2 e 4 da PJE">
        <div class="module-caption">Layout real dos Modulos 1, 2 e 4 na PJE (referencia visual para a pratica)</div>
    </div>

    <h2>Progressao Pedagogica</h2>
    <div class="diagram">
  INICIANTE          INTERMEDIARIO           AVANCADO
  (Modulos 1-3)      (Modulo 4 Linha)        (Modulo 4 Ultra)

  +---------+        +-------------+         +--------------+
  | Controle|  -->   |  Seguidor   |   -->   |  Navegacao   |
  | Direto  |        |  de Linha   |         |  Autonoma    |
  +---------+        +-------------+         +--------------+

  "Anda para         "Segue uma             "Explora o
   frente!"           linha preta"           ambiente sozinho"
    </div>

    <!-- SECAO 2 -->
    <h1 id="hardware">2. Conhecendo o Hardware</h1>

    <div class="box box-info">
        <h3>Voce nao precisa decorar</h3>
        <p>Veja as imagens e use esta tabela so quando precisar. O importante e saber onde ligar cada parte.</p>
    </div>

    <div class="mission-header">
        <div>
            <div class="mission-name">Missao: Conhecer as Pecas</div>
            <div class="mission-goal">Objetivo: Identificar partes principais</div>
            <div class="mission-reward">Selo: Montagem</div>
        </div>
        <div class="mission-badges"><span class="mission-badge">Hardware</span></div>
    </div>

    <h2>O Microcontrolador</h2>
    <p>Dentro do MostraBot existe uma <strong>placa-cerebro</strong> (Wemos D1 Mini). Pense nela como o <strong>cerebro do robo</strong>, que entende os comandos e conecta no Wi‑Fi. (Nome tecnico: Wemos D1 Mini com chip ESP8266).</p>

    <h2>Mapa dos Componentes</h2>
    <img class="module-img didactic-img" src="assets_full/03_hardware_componentes.png" alt="Mapa de componentes do robo">
    <div class="module-caption">Mapa rapido dos principais componentes</div>
    <div class="diagram">
            +--------------------------------------------+
            |           FRENTE DO ROBO                   |
            |                                            |
            |         +----------------+                 |
            |         |     GARRA      |                 |
            |         | (Servo1+Servo2)|                 |
            |         +----------------+                 |
            |                |                           |
            |         +------+------+                    |
            |         |   SENSOR    |                    |
            |         | ULTRASSONICO|                    |
            |         |   (Olhos)   |                    |
            |         +-------------+                    |
            |                                            |
            |    LED           LED                       |
            |  Esquerdo      Direito                     |
            |    (D8)         (D3)                       |
            |                                            |
            +--------------------------------------------+
            |                                            |
            |   +-----+              +-----+             |
            |   |Motor|              |Motor|             |
            |   |  1  |              |  2  |             |
            |   |(ESQ)|              |(DIR)|             |
            |   +-----+              +-----+             |
            |      |                   |                 |
            |     ooo                 ooo                |
            |    RODAS               RODAS               |
            +--------------------------------------------+
                        TRASEIRA DO ROBO
    </div>

    <h2>Tabela simples de onde cada coisa liga</h2>
    <table>
        <tr><th>Componente</th><th>Pino</th><th>GPIO</th><th>Funcao</th></tr>
        <tr><td>Roda esquerda (frente)</td><td>D0</td><td>GPIO16</td><td>Roda esquerda para frente</td></tr>
        <tr><td>Motor 1 Re</td><td>D5</td><td>GPIO14</td><td>Roda esquerda para tras</td></tr>
        <tr><td>Roda direita (frente)</td><td>D1</td><td>GPIO5</td><td>Roda direita para frente</td></tr>
        <tr><td>Motor 2 Re</td><td>D4</td><td>GPIO2</td><td>Roda direita para tras</td></tr>
        <tr><td>Garra (servo 1)</td><td>D6</td><td>GPIO12</td><td>Garra (servo esquerdo)</td></tr>
        <tr><td>Braco (servo 2)</td><td>D7</td><td>GPIO13</td><td>Garra (servo direito)</td></tr>
        <tr><td>D3 (Compartilhado)</td><td>D3</td><td>GPIO0</td><td>Ultra TRIG / Linha Dir / LED Dir</td></tr>
        <tr><td>D8 (Compartilhado)</td><td>D8</td><td>GPIO15</td><td>Ultra ECHO / Linha Esq / LED Esq</td></tr>
        <tr><td>LED/Buzzer</td><td>D2</td><td>GPIO4</td><td>LED externo e buzina</td></tr>
    </table>

    <div class="box box-danger">
        <h3>ATENCAO PROFESSOR!</h3>
        <p>Os pinos D3 e D8 sao <strong>compartilhados</strong>. Pense neles como "lugares delicados": por isso, so conecte os sensores <strong>depois</strong> que o robo estiver pronto.</p>
        <ol>
            <li>Os sensores devem estar <strong>DESCONECTADOS</strong> ao ligar o robo</li>
            <li>Conecte os sensores <strong>SOMENTE</strong> depois do robo conectar ao WiFi</li>
            <li>O robo sempre inicia em modo <strong>SENSOR OFF</strong></li>
        </ol>
        <p><strong>Na pratica:</strong> Ligue o robo, espere as 2 piscadas longas, depois conecte os sensores</p>
    </div>

    <!-- SECAO 3 -->
    <h1 id="sinais">3. Sinais Visuais do Robo <img class="icon-inline" src="assets_external/led_symbol_ext.svg" alt="LED"></h1>
    <div class="mission-header">
        <div>
            <div class="mission-name">Missao: Entender o LED</div>
            <div class="mission-goal">Objetivo: Saber quando esta pronto</div>
            <div class="mission-reward">Selo: Luz</div>
        </div>
        <div class="mission-badges"><span class="mission-badge">LED</span></div>
    </div>

    <p>Esta e uma das secoes mais importantes! O robo "fala" com voce atraves de LEDs. Aprenda a interpretar esses sinais.</p>

    <h2>Sequencia de Boot</h2>
    <img class="module-img didactic-img" src="assets_full/04_sinais_led.png" alt="LED mostra o status do robo">
    <div class="module-caption">O LED mostra se o robo esta conectando ou pronto</div>
    <div class="diagram">
  PASSO 1: Liga o robo
           |
           v
  PASSO 2: LED pisca rapido (50ms ON, 200ms OFF) - conectando WiFi
           * o * o * o * o * o * o
           |
           v
  PASSO 3: Conexao bem-sucedida?
           |
     +-----+-----+
     |           |
     v           v
   SIM          NAO
     |           |
     v           v
  LED pisca    LED pisca
  2 vezes      muito rapido
  (500ms)      (tentando reconectar)
     |
     v
  PASSO 4: Configurando DNS (pisca 100ms ON/OFF)
     |
     v
  PASSO 5: Robo esta online e pronto!
    </div>

    <h2>Resumo de Todos os Sinais</h2>
    <table class="signal-table">
        <tr><th>SINAL</th><th>SIGNIFICADO</th></tr>
        <tr><td>LED pisca rapido (50ms ON/200ms OFF)</td><td>Conectando ao WiFi...</td></tr>
        <tr><td>LED pisca 2x lento (500ms)</td><td>WiFi conectado com sucesso!</td></tr>
        <tr><td>LED pisca medio (100ms ON/OFF)</td><td>Configurando DNS</td></tr>
        <tr><td>LED pisca 1x a cada 3s</td><td>Heartbeat - robo saudavel</td></tr>
        <tr><td>LED aceso continuo</td><td>Executando comandos</td></tr>
        <tr><td>LED pisca rapido (300ms)</td><td>Perdeu conexao, tentando reconectar</td></tr>
        <tr><td>LED pisca 3x rapido</td><td>Erro ao buscar comandos da PJE</td></tr>
    </table>

    <div class="box box-info">
        <h3>LED de Heartbeat (Batimento Cardiaco)</h3>
        <p>Quando o robo esta conectado e funcionando normalmente, o LED pisca <strong>UMA VEZ</strong> a cada <strong>3 segundos</strong>. Isso indica que o robo esta conectado e saudavel!</p>
    </div>

    <!-- SECAO 4 -->
    <h1 id="primeiros-passos">4. Primeiros Passos</h1>
    <div class="mission-header">
        <div>
            <div class="mission-name">Missao: Primeiros Passos</div>
            <div class="mission-goal">Objetivo: Checklist inicial</div>
            <div class="mission-reward">Selo: Pronto</div>
        </div>
        <div class="mission-badges"><span class="mission-badge">Preparacao</span></div>
    </div>

    <h2>Checklist Pre-Operacao</h2>
    <div class="box">
        <ul>
            <li>[ ] Bateria carregada (ou fonte conectada)</li>
            <li>[ ] Sensores de linha DESCONECTADOS</li>
            <li>[ ] Sensor ultrassonico (sensor de distancia) DESCONECTADO</li>
            <li>[ ] Area livre de obstaculos perigosos</li>
            <li>[ ] Rede WiFi disponivel e funcionando</li>
            <li>[ ] Acesso a plataforma PJE no navegador</li>
        </ul>
    </div>

    <h2>Passo a Passo</h2>
    <ol>
        <li><strong>Ligue o robo</strong> - Pressione o botao de energia. Observe o LED comecar a piscar.</li>
        <li><strong>Aguarde a conexao WiFi</strong> - O LED pisca rapidamente (50ms ON, 200ms OFF).</li>
        <li><strong>Confirme a conexao</strong> - SUCESSO: 2 piscas lentas (500ms). FALHA: piscas muito rapidas.</li>
        <li><strong>Conecte os sensores</strong> - SOMENTE apos as 2 piscadas lentas.</li>
        <li><strong>Acesse a PJE</strong> - pje.ejrrobotica.com.br</li>
        <li><strong>Teste basico</strong> - Digite: <code>pf 500</code></li>
    </ol>


    <!-- SECAO 4A -->
    <h1 id="ligar-robo">4A. Como Ligar o Robo (Bateria + ID)</h1>
    <div class="mission-header">
        <div>
            <div class="mission-name">Missao: Acordar o Robo</div>
            <div class="mission-goal">Objetivo: Ligar e entrar na PJE</div>
            <div class="mission-reward">Selo: Energia</div>
        </div>
        <div class="mission-badges"><span class="mission-badge">Energia</span><span class="mission-badge">WiFi</span></div>
    </div>

    <div class="box box-danger">
        <h3>REGRA MAIS IMPORTANTE</h3>
        <p><strong>O robo NAO liga pela porta USB da Wemos.</strong> O cabo branco (V8) ja vem soldado na placa. Para ligar, conecte esse cabo branco na bateria externa. Ao conectar, o robo liga sozinho.</p>
        <p><strong>NUNCA</strong> ligue dois USBs ao mesmo tempo (ex.: bateria + Wemos).</p>
    </div>

    <h2>Passos Rapidos (3 passos)</h2>
    <img class="module-img mvp-img" src="assets_mvp/00_passos_rapidos.png" alt="Passos rapidos para ligar o robo e entrar na PJE">
    <div class="module-caption">Resumo visual: ID, bateria e entrada na PJE</div>

    <h2>PASSO 1: Encontre o ID do robo</h2>
    <p>O ID e um numero de <strong>4 digitos</strong> colado na bateria (fita amarela). Anote esse numero.</p>
    <img class="module-img mvp-img" src="assets_mvp/01_id.png" alt="Onde encontrar o ID de 4 digitos na bateria">
    <div class="module-caption">Exemplo de ID na fita amarela (4 digitos)</div>

    <h2>PASSO 2: Conecte o cabo branco na bateria <img class="icon-inline" src="assets_icons/battery.svg" alt="Bateria"></h2>
    <p>O cabo branco ja vem soldado no robo. Conecte ele na bateria externa. <strong>Ao conectar, o robo liga automaticamente.</strong></p>
    <img class="module-img mvp-img" src="assets_mvp/02_cabo_branco.png" alt="Cabo branco ja vem soldado no robo">
    <div class="module-caption">O cabo branco ja vem pronto no robo</div>
    <img class="module-img mvp-img" src="assets_mvp/03_ligar_na_bateria.png" alt="Conectar cabo branco na bateria para ligar">
    <div class="module-caption">Conectar na bateria = robo ligado</div>

    <h2>PASSO 3: Veja o LED <img class="icon-inline" src="assets_icons/led.svg" alt="LED"></h2>
    <ul>
        <li><strong>Pisca rapido</strong> = conectando no Wi-Fi</li>
        <li><strong>Duas piscadas lentas</strong> = pronto para usar</li>
    </ul>
    <img class="module-img mvp-img" src="assets_mvp/04_led_status.png" alt="LED mostra o status do robo">
    <div class="module-caption">LED indica quando o robo esta pronto</div>

    <h2>O que NAO fazer <img class="icon-inline" src="assets_external/usb_ext.svg" alt="USB"></h2>
    <ul>
        <li>NAO usar a USB da Wemos para ligar o robo.</li>
        <li>A USB da Wemos e apenas para atualizar o programa do robo (firmware).</li>
        <li>NAO ligar dois USBs ao mesmo tempo.</li>
    </ul>
    <img class="module-img mvp-img" src="assets_mvp/05_nao_usb_wemos.png" alt="Nao ligar o robo pela USB da Wemos">
    <div class="module-caption">USB da Wemos so para atualizar o programa</div>

    <h2>Entrando na PJE <img class="icon-inline" src="assets_external/wifi_ext.svg" alt="WiFi"></h2>
    <ol>
        <li>Acesse <a href="https://pje.ejrrobotica.com.br/index.php" target="_blank" rel="noopener noreferrer"><strong>pje.ejrrobotica.com.br</strong></a>.</li>
        <li>No menu superior, clique em <strong>Programar</strong>.</li>
        <li>Digite o <strong>ID da fita amarela da bateria</strong> (4 digitos).</li>
        <li>Senha padrao: <strong>123</strong>.</li>
        <li>Na caixa de selecao, escolha <strong>Modulo 1</strong> para a missao inicial.</li>
        <li>Clique em <strong>Entrar</strong>.</li>
    </ol>
    <img class="module-img didactic-img" src="pje-programar.png" alt="Clique em Programar no topo da PJE">
    <div class="module-caption">Acesso: menu Programar no topo da pagina da PJE</div>
    <img class="module-img didactic-img" src="login_pje.png" alt="Login da PJE com ID, senha e modulo">
    <div class="module-caption">Login: ID da fita amarela, senha 123 e selecao de modulo</div>
    <img class="module-img didactic-img" src="assets_lessons/11_pje_menu_programar.svg" alt="Guia vetorizado: clique em Programar">
    <div class="module-caption">Guia vetorizado: clique em Programar</div>
    <img class="module-img didactic-img" src="assets_lessons/12_pje_login_id_senha.svg" alt="Guia vetorizado: login na PJE">
    <div class="module-caption">Guia vetorizado: login com ID, senha e modulo</div>

    <div class="mission-task">
        <div class="mission-task-title">Tarefa da Missao 0 (conclusao rapida)</div>
        <ol>
            <li>No site da PJE nuvem, clique em <strong>Programar</strong>.
                <div class="task-visual"><img src="pje-programar.png" alt="Programar no topo da PJE"></div>
            </li>
            <li>Na pagina de login, digite o <strong>ID da fita amarela da bateria</strong>, senha <strong>123</strong> e escolha <strong>Modulo 1</strong> para esta atividade.
                <div class="task-visual"><img src="login_pje.png" alt="Login da PJE com ID, senha e selecao de modulo"></div>
            </li>
            <li>Fazer 3 exercicios de validacao, sempre clicando no botao e depois em <strong>ENVIAR</strong>:
                <br>1) acender LED direito (<strong>LD</strong>)
                <br>2) acender LED esquerdo (<strong>LE</strong>)
                <br>3) buzinar (<strong>BU</strong>)
                <div class="task-visual"><img src="mod1.png" alt="Tela do Modulo 1 para executar LD, LE e BU"></div>
            </li>
            <li>Confirmar que os 3 testes funcionaram no robo.
                <br><strong>Bonus:</strong> se chegou ate aqui, de o primeiro passo com o robo: clique em <strong>PF</strong> para ir para frente.
            </li>
        </ol>
        <p><strong>Missao concluida:</strong> robo piscou LED no teste inicial.</p>
        <p><strong>Link direto do modulo:</strong> <a href="https://pje.ejrrobotica.com.br/modulo1.php" target="_blank" rel="noopener noreferrer">Modulo 1 (PJE Nuvem)</a>.</p>
    </div>

    <!-- SECAO 5 -->
    <h1 id="movimento">5. Comandos de Movimento <img class="icon-inline" src="assets_icons/dc_motor.svg" alt="Motor"></h1>
    <div class="mission-header">
        <div>
            <div class="mission-name">Missao: Caminho Seguro</div>
            <div class="mission-goal">Objetivo: Andar e virar</div>
            <div class="mission-reward">Selo: Direcao</div>
        </div>
        <div class="mission-badges"><span class="mission-badge">Movimento</span></div>
    </div>
    <div class="mission-task">
        <div class="mission-task-title">Tarefa da Missao 1 (Modulo 1)</div>
        <ol>
            <li>Acesse o <a href="https://pje.ejrrobotica.com.br/modulo1.php" target="_blank" rel="noopener noreferrer"><strong>Modulo 1</strong></a>.
                <div class="task-visual"><img src="mod1.png" alt="Escolha e acesso ao modulo da missao"></div>
            </li>
            <li>Escolha tempo 1000 no select.</li>
            <li>Clique em PF e ENVIAR.
                <div class="task-visual"><img src="assets_full/05_movimento_botoes.png" alt="Botoes PF e ENVIAR no modulo 1"></div>
            </li>
            <li>Repita com PD (200) para virar.</li>
        </ol>
        <p><strong>Missao concluida:</strong> robo andou e virou no modulo correto.</p>
    </div>

    <h2>Layout dos Modulos (M1, M2 e M4)</h2>
    <img class="module-img" src="assets_full/05_movimento_botoes.png" alt="Botoes de movimento na PJE">
    <div class="module-caption">Botoes PF, PT, PD, PE</div>
    <ul>
        <li><strong>Modulo 1:</strong> botoes verdes (PF, PT, PD, PE, LD, LE, LDE, BU, BC, SC) e <strong>select de tempo</strong> com valores prontos.</li>
        <li><strong>Modulo 2:</strong> comandos semi-prontos por cliques, com selecao de tempo <code>t</code> e milissegundos para cada acao.</li>
        <li><strong>Modulo 4:</strong> comandos manuais completos no campo de texto, com sensores e logica.</li>
    </ul>
    <img class="module-img" src="modulos.png" alt="Modulos 1, 2 e 4 - PJE">
    <div class="module-caption">Use esta imagem para associar exemplos do manual ao layout real da PJE</div>

    <h3>Exemplo no Modulo 1 (cliques)</h3>
    <ol>
        <li>Escolha o tempo no select (ex.: <strong>1000</strong>).</li>
        <li>Clique no botao verde <strong>PF</strong>.</li>
        <li>Clique em <strong>ENVIAR</strong>.</li>
    </ol>
    <p>No Modulo 1 nao existe digitacao de comandos. No Modulo 2 a montagem ainda e guiada (semi-pronta). A escrita totalmente manual acontece no Modulo 4.</p>

    <h2>Os 4 Comandos Basicos</h2>
    <div class="diagram">
                          ^
                          |
                     +---------+
                     |   PF    |  PF = Para Frente
                     | FRENTE  |
                     +---------+

            &lt;--------------+--------------&gt;
       +---------+         |         +---------+
       |   PE    |         |         |   PD    |
       |ESQUERDA |         |         | DIREITA |
       +---------+         |         +---------+
                           |
                     +---------+
                     |   PT    |  PT = Para Tras
                     |  TRAS   |
                     +---------+
                           |
                           v
    </div>

    <h2>Sintaxe</h2>
    <pre>COMANDO &lt;tempo_em_ms&gt;</pre>

    <h2>Exemplos</h2>
    <table>
        <tr><th>Comando</th><th>Significado</th><th>Duracao</th></tr>
        <tr><td><code>pf 1000</code></td><td>Anda para frente</td><td>1 segundo</td></tr>
        <tr><td><code>pf 500</code></td><td>Anda para frente</td><td>0.5 segundos</td></tr>
        <tr><td><code>pt 1000</code></td><td>Anda para tras</td><td>1 segundo</td></tr>
        <tr><td><code>pd 200</code></td><td>Gira para direita</td><td>~90 graus</td></tr>
        <tr><td><code>pe 200</code></td><td>Gira para esquerda</td><td>~90 graus</td></tr>
        <tr><td><code>pf</code></td><td>Anda para frente</td><td>120ms (padrao)</td></tr>
    </table>

    <h2>Referencia de Angulos de Giro</h2>
    <table>
        <tr><th>Angulo</th><th>Tempo</th><th>Comando</th></tr>
        <tr><td>45 graus</td><td>~110ms</td><td><code>pd 110</code> ou <code>pe 110</code></td></tr>
        <tr><td>90 graus</td><td>~200-220ms</td><td><code>pd 200</code> ou <code>pe 200</code></td></tr>
        <tr><td>180 graus</td><td>~440ms</td><td><code>pd 440</code> ou <code>pe 440</code></td></tr>
        <tr><td>360 graus</td><td>~880ms</td><td><code>pd 880</code> ou <code>pe 880</code></td></tr>
    </table>

    <h2>Exemplos de Movimento (com pausa de protecao)</h2>

    <h3>Quadrado seguro</h3>
    <div class="shape-diagram">+------+ 
|      |
|      |
+------+</div>
    <div class="pje-example">
        <div class="pje-label">Modulo 2/4</div>
        <div class="pje-textarea"><pre>pf 1000
t 50
pd 220
t 50
pf 1000
t 50
pd 220
t 50
pf 1000
t 50
pd 220
t 50
pf 1000
t 50
pd 220</pre></div>
        <div class="pje-send">ENVIAR</div>
    </div>

    <h3>Triangulo seguro</h3>
    <div class="shape-diagram">  /\
 /  \
/____\</div>
    <div class="pje-example">
        <div class="pje-label">Modulo 2/4</div>
        <div class="pje-textarea"><pre>pf 1000
t 50
pd 260
t 50
pf 1000
t 50
pd 260
t 50
pf 1000
t 50
pd 260</pre></div>
        <div class="pje-send">ENVIAR</div>
    </div>

    <h3>Zigue-zague seguro</h3>
    <div class="shape-diagram">/\/\_/\/\</div>
    <div class="pje-example">
        <div class="pje-label">Modulo 2/4</div>
        <div class="pje-textarea"><pre>pf 500
t 50
pd 120
t 50
pf 500
t 50
pe 120
t 50
pf 500
t 50
pd 120</pre></div>
        <div class="pje-send">ENVIAR</div>
    </div>

    <!-- SECAO 6 -->
    <h1 id="led">6. Comandos de LED (Olhos) <img class="icon-inline" src="assets_icons/led.svg" alt="LED"></h1>
    <div class="mission-header">
        <div>
            <div class="mission-name">Missao: Olhos que Piscam</div>
            <div class="mission-goal">Objetivo: Usar LEDs</div>
            <div class="mission-reward">Selo: Luz</div>
        </div>
        <div class="mission-badges"><span class="mission-badge">LED</span></div>
    </div>
    <div class="mission-task">
        <div class="mission-task-title">Tarefa da Missao 2 (Modulo 1)</div>
        <div class="mission-mini-hud">Voce esta aqui: Missao 2 > Passo 1 (abrir Programar) | Progresso da missao: 1/4</div>
        <div class="mission-inline-checklist">
            Checklist rapido antes de comecar:
            <ul>
                <li>Robo ligado e com LED de pronto</li>
                <li>Internet ativa</li>
                <li>ID da fita amarela em maos</li>
            </ul>
        </div>
        <ol>
            <li>No site da PJE nuvem, clique em <strong>Programar</strong> no menu do topo.
                <div class="task-visual"><img src="pje-programar.png" alt="Passo 1 da Missao 2: clicar em Programar"></div>
                <div class="task-visual"><img src="assets_lessons/11_pje_menu_programar.svg" alt="Guia visual do clique em Programar"></div>
                <a class="mini-review-link" href="#intro">Rever demonstracao rapida deste clique</a>
            </li>
            <li>Chegou na tela de login? Se <strong>sim</strong>, continue. Se <strong>nao</strong>, volte e clique em Programar novamente.
                <br>No login: digite o <strong>ID da fita amarela</strong>, senha <strong>123</strong> e selecione <strong>Modulo 1</strong>.
                <div class="task-visual"><img src="login_pje.png" alt="Passo 2 da Missao 2: tela de login da PJE"></div>
                <div class="task-visual"><img src="assets_lessons/12_pje_login_id_senha.svg" alt="Guia visual do login com ID e senha"></div>
            </li>
            <li>Clique em <strong>Entrar</strong> e confirme que abriu o Modulo 1.
                <div class="task-visual"><img src="mod1.png" alt="Passo 3 da Missao 2: tela do Modulo 1"></div>
                <div class="task-visual"><img src="assets_lessons/13_pje_modulo_missao.svg" alt="Guia visual da selecao do modulo da missao"></div>
            </li>
            <li>Agora execute o treino de LED: clique em <strong>LD</strong> e ENVIAR, depois <strong>LE</strong> e ENVIAR.
                <div class="task-visual"><img src="assets_full/06_led_botoes.png" alt="Botoes de LED no modulo 1"></div>
                <div class="task-visual"><img src="assets_lessons/04_led_feedback.svg" alt="Feedback visual esperado dos LEDs"></div>
            </li>
        </ol>
        <div class="ms-box">
            <strong>Como ler tempo em ms:</strong> ms significa milissegundos.
            <br>1 segundo = <strong>1000 ms</strong>.
            <br>Se for menor que 1 segundo, use decimal:
            <br><strong>0.5 s = 500 ms</strong>, <strong>0.2 s = 200 ms</strong>, <strong>0.1 s = 100 ms</strong>.
            <br>Regra rapida: <strong>x segundos -> x * 1000 = ms</strong>.
        </div>
        <p><strong>Missao concluida:</strong> os dois olhos piscaram conforme o comando.</p>
        <p><strong>Feedback:</strong> boa. Voce concluiu a base visual da Missao 2 com seguranca.</p>
    </div>
    <img class="module-img" src="assets_full/06_led_botoes.png" alt="Botoes de LED na PJE">
    <div class="module-caption">Use LD, LE e LDE para os olhos</div>

    <table>
        <tr><th>Comando</th><th>Descricao</th><th>Pino</th></tr>
        <tr><td><code>ld &lt;ms&gt;</code></td><td>Pisca LED direito</td><td>D3</td></tr>
        <tr><td><code>le &lt;ms&gt;</code></td><td>Pisca LED esquerdo</td><td>D8</td></tr>
        <tr><td><code>lde &lt;ms&gt;</code></td><td>Pisca AMBOS LEDs</td><td>D3+D8</td></tr>
    </table>

    <p>Se nao especificar o tempo, o LED pisca por <strong>500ms</strong> (padrao).</p>

    <div class="box box-warning">
        <h3>ATENCAO!</h3>
        <p>Os LEDs D3 e D8 compartilham os pinos com os sensores! Antes de usar comandos de LED, execute: <code>sensor off</code></p>
    </div>

    <!-- SECAO 7 -->
    <h1 id="servo">7. Comandos de Servo (Garra) <img class="icon-inline" src="assets_icons/servo.svg" alt="Servo"></h1>
    <div class="mission-header">
        <div>
            <div class="mission-name">Missao: Garra Colecionadora</div>
            <div class="mission-goal">Objetivo: Abrir e fechar</div>
            <div class="mission-reward">Selo: Garra</div>
        </div>
        <div class="mission-badges"><span class="mission-badge">Garra</span></div>
    </div>
    <div class="mission-task">
        <div class="mission-task-title">Tarefa da Missao 3 (Modulo 2)</div>
        <ol>
            <li>Acesse o <a href="https://pje.ejrrobotica.com.br/modulo2.php" target="_blank" rel="noopener noreferrer"><strong>Modulo 2</strong></a>.</li>
            <li>Digite: <code>sc</code>, <code>t 100</code>, <code>bc</code>.
                <div class="task-visual"><img src="assets_full/07_servo_botoes.png" alt="Comandos de garra no modulo 2"></div>
            </li>
            <li>Clique em ENVIAR.</li>
            <li>Observe a garra abrir e fechar.</li>
        </ol>
        <p><strong>Missao concluida:</strong> garra respondeu ao programa digitado.</p>
    </div>
    <img class="module-img" src="assets_full/07_servo_botoes.png" alt="Botoes da garra na PJE">
    <div class="module-caption">BC = baixa a garra, SC = sobe a garra</div>

    <table>
        <tr><th>Comando</th><th>Descricao</th><th>Angulo</th></tr>
        <tr><td><code>bc</code></td><td>Baixar/Fechar garra</td><td>10 graus</td></tr>
        <tr><td><code>sc</code></td><td>Subir/Abrir garra</td><td>170 graus</td></tr>
        <tr><td><code>servo1 &lt;ang&gt;</code></td><td>Controle fino servo 1</td><td>0-180 graus</td></tr>
        <tr><td><code>servo2 &lt;ang&gt;</code></td><td>Controle fino servo 2</td><td>0-180 graus</td></tr>
    </table>

    <h3>Exemplo: Pegar objeto</h3>
    <div class="pje-example">
        <div class="pje-label">Modulo 2/4</div>
        <div class="pje-textarea"><pre>sc              # Abre a garra
t 50
pf 500          # Aproxima do objeto
t 50
bc              # Fecha a garra
t 50
pt 500          # Recua com o objeto</pre></div>
        <div class="pje-send">ENVIAR</div>
    </div>

    <!-- SECAO 8 -->
    <h1 id="buzzer">8. Comando de Buzzer (Som) <img class="icon-inline" src="assets_icons/buzzer.svg" alt="Buzzer"></h1>
    <div class="mission-header">
        <div>
            <div class="mission-name">Missao: Som do Robo</div>
            <div class="mission-goal">Objetivo: Usar buzzer</div>
            <div class="mission-reward">Selo: Som</div>
        </div>
        <div class="mission-badges"><span class="mission-badge">Som</span></div>
    </div>
    <div class="mission-task">
        <div class="mission-task-title">Tarefa extra (Modulo 2)</div>
        <ol>
            <li>Acesse o <a href="https://pje.ejrrobotica.com.br/modulo2.php" target="_blank" rel="noopener noreferrer"><strong>Modulo 2</strong></a>.</li>
            <li>Digite <code>bu 300</code> e envie.
                <div class="task-visual"><img src="assets_full/08_buzzer_botao.png" alt="Botao de buzzer no modulo 2"></div>
            </li>
            <li>Repita com <code>bu 100</code>.</li>
        </ol>
        <p><strong>Concluido:</strong> aluno percebeu relacao entre tempo e duracao do som.</p>
    </div>
    <img class="module-img" src="assets_full/08_buzzer_botao.png" alt="Botao BU na PJE">
    <div class="module-caption">BU faz o bip do robo</div>

    <pre>bu &lt;tempo_em_ms&gt;</pre>
    <p>Frequencia: <strong>2000 Hz</strong> | Padrao: <strong>800ms</strong></p>
    <p><strong>Pausa silenciosa:</strong> se quiser apenas dar tempo ao robo sem som, use o comando <code>t &lt;ms&gt;</code>.</p>

    <h3>Exemplos</h3>
    <div class="pje-example">
        <div class="pje-label">Modulo 2/4</div>
        <div class="pje-textarea"><pre>bu 500          # Bipe de 0.5 segundos
bu              # Bipe de 800ms (padrao)</pre></div>
        <div class="pje-send">ENVIAR</div>
    </div>

    <!-- SECAO 9 -->
    <h1 id="linha">9. Sensor de Linha (segue a faixa) <img class="icon-inline" src="assets_icons/check.svg" alt="Linha"></h1>
    <div class="mission-header">
        <div>
            <div class="mission-name">Missao: Seguir Trilhos</div>
            <div class="mission-goal">Objetivo: Seguir a linha</div>
            <div class="mission-reward">Selo: Trilho</div>
        </div>
        <div class="mission-badges"><span class="mission-badge">Sensor</span></div>
    </div>
    <div class="mission-task">
        <div class="mission-task-title">Tarefa da Missao 4 (Modulo 4)</div>
        <ol>
            <li>Acesse o <a href="https://pje.ejrrobotica.com.br/modulo4.php" target="_blank" rel="noopener noreferrer"><strong>Modulo 4</strong></a>.</li>
            <li>Digite o bloco: <code>sensor linha</code> + <code>seguir-linha</code>.
                <div class="task-visual"><img src="assets_full/09_linha_sensor.png" alt="Exemplo do sensor de linha no modulo 4"></div>
            </li>
            <li>Envie e observe o robo seguir a faixa.</li>
            <li>Finalize com <code>sensor off</code>.</li>
        </ol>
        <p><strong>Missao concluida:</strong> robo seguiu a pista com sensor de linha.</p>
    </div>
    <img class="module-img didactic-img" src="assets_full/09_linha_sensor.png" alt="Sensor de linha">
    <div class="module-caption">O robo segue a linha no chao</div>

    <h2>Como Funciona</h2>
    <div class="diagram">
                      SENSORES IR
                    +-----+-----+
                    | ESQ | DIR |
                    | D8  | D3  |
                    +--+--+--+--+
                       |     |
                       v     v
   ==============+===========+=================
   BRANCO        |   LINHA   |    BRANCO
                 |   PRETA   |
   ==============+===========+=================

   A linha deve passar ENTRE os dois sensores!
    </div>

    <h2>Logica de Deteccao</h2>
    <table>
        <tr><th>Situacao</th><th>Sensor Esquerdo</th><th>Sensor Direito</th><th>Acao</th></tr>
        <tr><td>Centralizado</td><td>HIGH (branco)</td><td>HIGH (branco)</td><td>Segue reto</td></tr>
        <tr><td>Desviou p/ esquerda</td><td>LOW (linha)</td><td>HIGH (branco)</td><td>Corrige p/ esquerda</td></tr>
        <tr><td>Desviou p/ direita</td><td>HIGH (branco)</td><td>LOW (linha)</td><td>Corrige p/ direita</td></tr>
        <tr><td>Cruzamento/Fim</td><td>LOW (linha)</td><td>LOW (linha)</td><td>Reduz velocidade</td></tr>
    </table>

    <h2>Ativando</h2>
    <div class="pje-example">
        <div class="pje-label">Modulo 4</div>
        <div class="pje-textarea"><pre>sensor linha
repita 50
  seguir-linha 100
  t 50
fim repita
sensor off
bu 500</pre></div>
        <div class="pje-send">ENVIAR</div>
    </div>

    <h2>Dicas para a Pista</h2>
    <div class="box box-success">
        <ul>
            <li><strong>[OK]</strong> Use fita isolante preta sobre cartolina branca</li>
            <li><strong>[OK]</strong> Largura da linha: 2-3 cm</li>
            <li><strong>[OK]</strong> Curvas suaves (nao muito fechadas)</li>
            <li><strong>[OK]</strong> Superficie fosca (evite brilho)</li>
            <li><strong>[X]</strong> Evite linhas muito finas (&lt; 1.5cm)</li>
            <li><strong>[X]</strong> Evite curvas em angulo reto (90 graus)</li>
            <li><strong>[X]</strong> Evite luz solar direta</li>
        </ul>
    </div>

    <!-- SECAO 10 -->
    <h1 id="ultra">10. Sensor Ultrassonico (sensor de distancia) <img class="icon-inline" src="assets_icons/warning.svg" alt="Ultrassom"></h1>
    <div class="mission-header">
        <div>
            <div class="mission-name">Missao: Desvio de Obstaculos</div>
            <div class="mission-goal">Objetivo: Desviar automaticamente</div>
            <div class="mission-reward">Selo: Desvio</div>
        </div>
        <div class="mission-badges"><span class="mission-badge">Sensor</span></div>
    </div>
    <div class="mission-task">
        <div class="mission-task-title">Tarefa da Missao 5 (Modulo 4)</div>
        <ol>
            <li>Acesse o <a href="https://pje.ejrrobotica.com.br/modulo4.php" target="_blank" rel="noopener noreferrer"><strong>Modulo 4</strong></a>.</li>
            <li>Digite: <code>sensor ultra</code> e depois <code>seguir-ultra 2000</code>.
                <div class="task-visual"><img src="assets_full/10_ultra_sensor.png" alt="Exemplo do sensor ultrassonico no modulo 4"></div>
            </li>
            <li>Envie e coloque um obstaculo na frente.</li>
            <li>Verifique o desvio automatico e finalize com <code>sensor off</code>.</li>
        </ol>
        <p><strong>Missao concluida:</strong> robo detectou e desviou do obstaculo.</p>
    </div>
    <img class="module-img didactic-img" src="assets_full/10_ultra_sensor.png" alt="Sensor ultrassonico (sensor de distancia)">
    <div class="module-caption">Desvia de obstaculos automaticamente</div>

    <h2>Como Funciona</h2>
    <div class="diagram">
                         SENSOR HC-SR04
                    +-------------------+
                    |    (o)     (o)    |
                    |   TRIG    ECHO    |
                    |    D3      D8     |
                    +-------------------+
                            |
                            |  Envia onda sonora
                            |  =================>  +----------+
                            |                      |          |
                            |  Recebe eco          | OBSTACULO|
                            |  <=================  |          |
                            |                      +----------+

   Tempo entre envio e retorno = Distancia ao obstaculo
   Alcance: 2cm a 300cm (3 metros)
    </div>

    <h2>Comando de Navegacao</h2>
    <table>
        <tr><th>Comando</th><th>Descricao</th></tr>
        <tr><td><code>seguir-ultra &lt;ms&gt;</code></td><td>Navegacao com desvio de obstaculos</td></tr>
    </table>

    <div class="box box-info">
        <h3>Como funciona o seguir-ultra</h3>
        <ol>
            <li>Anda para frente ate detectar obstaculo (&lt;=20cm)</li>
            <li>Ao detectar (3 leituras consecutivas para confirmar):
                <ul>
                    <li>Desacelera suavemente (rampa anti-picos)</li>
                    <li>Para completamente</li>
                    <li>Da re curta (120ms)</li>
                    <li>Gira para encontrar saida (direita/esquerda alternado)</li>
                </ul>
            </li>
            <li>Se todas direcoes bloqueadas: re extra (200ms) e tenta novamente</li>
        </ol>
    </div>

    <h2>Exemplo</h2>
    <div class="pje-example">
        <div class="pje-label">Modulo 4</div>
        <div class="pje-textarea"><pre>sensor ultra
repita 30
  seguir-ultra 2000
  t 50
fim repita
sensor off
bu 500</pre></div>
        <div class="pje-send">ENVIAR</div>
    </div>

    <h3>Exemplo estavel com pausas (recomendado)</h3>
    <div class="pje-example">
        <div class="pje-label">Modulo 4</div>
        <div class="pje-textarea"><pre>sensor ultra
repita 100
  pf 80
  t 65
  se dist 30
    pt 150
    t 65
    pd 150
    t 65
  fim se
  t 65
fim repita
sensor off
t 500</pre></div>
        <div class="pje-send">ENVIAR</div>
    </div>

    <h2>Dicas para o Ambiente</h2>
    <div class="box box-success">
        <ul>
            <li><strong>[OK]</strong> Use obstaculos solidos (caixas, paredes)</li>
            <li><strong>[OK]</strong> Superficies perpendiculares ao sensor</li>
            <li><strong>[OK]</strong> Espaco minimo de 50cm entre obstaculos</li>
            <li><strong>[X]</strong> Evite objetos muito finos (pernas de cadeira)</li>
            <li><strong>[X]</strong> Evite materiais absorventes (espuma, tecido)</li>
        </ul>
    </div>

    <!-- SECAO 11 -->
    <h1 id="controle">11. Estruturas de Controle</h1>
    <div class="mission-header">
        <div>
            <div class="mission-name">Missao: Repetir e Reagir</div>
            <div class="mission-goal">Objetivo: Usar REPITA e SE</div>
            <div class="mission-reward">Selo: Mestre</div>
        </div>
        <div class="mission-badges"><span class="mission-badge">Logica</span></div>
    </div>
    <div class="mission-task">
        <div class="mission-task-title">Tarefa da Missao 6 (Modulo 4)</div>
        <ol>
            <li>Acesse o <a href="https://pje.ejrrobotica.com.br/modulo4.php" target="_blank" rel="noopener noreferrer"><strong>Modulo 4</strong></a>.</li>
            <li>Monte um programa com <code>repita</code> e <code>se</code>.
                <div class="task-visual"><img src="assets_full/11_repita.png" alt="Comando repita no modulo 4"></div>
            </li>
            <li>Envie e observe se o robo reage a condicao.</li>
            <li>Ajuste tempo ate o comportamento ficar estavel.</li>
        </ol>
        <p><strong>Missao concluida:</strong> aluno criou comportamento com repeticao e decisao.</p>
    </div>

    <h2>REPITA (Loop)</h2>
    <img class="module-img didactic-img" src="assets_full/11_repita.png" alt="Exemplo de REPITA">
    <div class="module-caption">Exemplo simples de repeticao</div>
    <pre>repita &lt;N&gt;
  &lt;comandos&gt;
fim repita</pre>
    <p><strong>Maximo:</strong> 3 niveis de aninhamento</p>

    <h3>Exemplo: Quadrado</h3>
    <div class="pje-example">
        <div class="pje-label">Modulo 2/4</div>
        <div class="pje-textarea"><pre>repita 4
  pf 500
  t 50
  pd 200
  t 50
fim repita</pre></div>
        <div class="pje-send">ENVIAR</div>
    </div>

    <h2>SE (Condicional)</h2>
    <img class="module-img didactic-img" src="assets_full/12_se.png" alt="Exemplo de SE">
    <div class="module-caption">Se a condicao for verdadeira, o robo executa</div>
    <pre>se &lt;condicao&gt;
  &lt;comandos&gt;
fim se</pre>

    <h3>Exemplo com sensor de linha (segue a faixa)</h3>
    <div class="pje-example">
        <div class="pje-label">Modulo 4</div>
        <div class="pje-textarea"><pre>sensor linha
se sensord
  pd 150
  t 50
fim se
sensor off</pre></div>
        <div class="pje-send">ENVIAR</div>
    </div>

    <h2>Combinando REPITA e SE</h2>
    <div class="pje-example">
        <div class="pje-label">Modulo 4</div>
        <div class="pje-textarea"><pre>sensor linha
repita 30
  seguir-linha 100
  t 50
  se perdeu
    pt 200
    t 50
    pd 200
    t 50
  fim se
fim repita
sensor off</pre></div>
        <div class="pje-send">ENVIAR</div>
    </div>

    <!-- SECAO 12 -->
    <h1 id="condicoes">12. Condicoes para o SE (escolhas)</h1>
    <div class="mission-header">
        <div>
            <div class="mission-name">Missao: Entender Condicoes</div>
            <div class="mission-goal">Objetivo: Escolher a condicao certa</div>
            <div class="mission-reward">Selo: Leitor</div>
        </div>
        <div class="mission-badges"><span class="mission-badge">Logica</span></div>
    </div>

    <h2>Condicoes de Linha</h2>
    <img class="module-img didactic-img" src="assets_full/13_condicoes_linha.png" alt="Condicoes do sensor de linha (segue a faixa)">
    <div class="module-caption">Condições mais usadas no sensor de linha (segue a faixa)</div>
    <table>
        <tr><th>Condicao</th><th>Significado</th></tr>
        <tr><td><code>sensord</code></td><td>Sensor DIREITO na linha (preto)</td></tr>
        <tr><td><code>nsensord</code></td><td>Sensor DIREITO no branco</td></tr>
        <tr><td><code>sensore</code></td><td>Sensor ESQUERDO na linha (preto)</td></tr>
        <tr><td><code>nsensore</code></td><td>Sensor ESQUERDO no branco</td></tr>
        <tr><td><code>linhaok</code></td><td>AMBOS no branco (centralizado)</td></tr>
        <tr><td><code>perdeu</code></td><td>AMBOS na linha (cruzamento)</td></tr>
    </table>

    <h2>Condicoes de Ultrassom</h2>
    <img class="module-img didactic-img" src="assets_full/14_condicoes_ultra.png" alt="Condicoes do ultrassom">
    <div class="module-caption">Condições mais usadas no ultrassom</div>
    <table>
        <tr><th>Condicao</th><th>Significado</th><th>Exemplo</th></tr>
        <tr><td><code>dist X</code></td><td>Distancia &lt;= X cm (obstaculo proximo)</td><td><code>se dist 20</code></td></tr>
        <tr><td><code>distm X</code></td><td>Distancia &gt;= X cm (caminho livre)</td><td><code>se distm 50</code></td></tr>
    </table>

    <h3>Exemplo</h3>
    <div class="pje-example">
        <div class="pje-label">Modulo 4</div>
        <div class="pje-textarea"><pre>sensor ultra
se dist 20
  pt 300
  t 50
  pd 200
  t 50
fim se
sensor off</pre></div>
        <div class="pje-send">ENVIAR</div>
    </div>
    <div class="box box-info">
        <p><strong>Legenda rapida:</strong> <code>dist 20</code> = distancia &lt;= 20 <strong>cm</strong> (obstaculo perto) ativa o desvio | <code>pt</code> recua | <code>pd</code> gira | <code>t 50</code> estabiliza</p>
    </div>

    <h3>Exemplos adicionais (condicoes)</h3>

    <div class="shape-diagram">[X] obstaculo perto -> recuo curto -> giro -> avance</div>
    <div class="pje-example">
        <div class="pje-label">Modulo 4</div>
        <div class="pje-textarea"><pre>sensor ultra
se dist 10
  bu 100
  pt 250
  t 50
  pe 220
  t 50
fim se
sensor off</pre></div>
        <div class="pje-send">ENVIAR</div>
    </div>
    <div class="box box-info">
        <p><strong>Legenda rapida:</strong> <code>dist 10</code> = distancia &lt;= 10 <strong>cm</strong> (emergencia) | giro para esquerda | pausas para estabilidade</p>
    </div>

    <div class="shape-diagram">[ ] caminho livre -> avance rapido</div>
    <div class="pje-example">
        <div class="pje-label">Modulo 4</div>
        <div class="pje-textarea"><pre>sensor ultra
se distm 30
  pf 400
  t 50
fim se
sensor off</pre></div>
        <div class="pje-send">ENVIAR</div>
    </div>
    <div class="box box-info">
        <p><strong>Legenda rapida:</strong> <code>distm 30</code> = distancia &gt;= 30 <strong>cm</strong> (caminho livre) | avance com pausa</p>
    </div>

    <!-- SECAO 13 -->
    <h1 id="calibracao">13. Calibracao dos Motores</h1>
    <div class="mission-header">
        <div>
            <div class="mission-name">Missao: Deixar Reto</div>
            <div class="mission-goal">Objetivo: Calibrar se puxa</div>
            <div class="mission-reward">Selo: Ajuste</div>
        </div>
        <div class="mission-badges"><span class="mission-badge">Ajuste</span></div>
    </div>
    <img class="module-img didactic-img" src="assets_full/15_calibracao.png" alt="Calibracao dos motores">
    <div class="module-caption">Use quando o robo puxa para um lado</div>

    <div class="box box-info">
        <h3>Por que Calibrar?</h3>
        <p>Cada motor tem caracteristicas ligeiramente diferentes. Sem calibracao, o robo pode desviar para um lado ao andar em linha reta.</p>
    </div>

    <h2>Comandos</h2>
    <table>
        <tr><th>Comando</th><th>Descricao</th></tr>
        <tr><td><code>atrasar_mote &lt;valor&gt;</code></td><td>Reduz forca do motor ESQUERDO</td></tr>
        <tr><td><code>atrasar_motd &lt;valor&gt;</code></td><td>Reduz forca do motor DIREITO</td></tr>
    </table>

    <h2>Procedimento</h2>
    <ol>
        <li>Execute <code>pf 3000</code> e observe para qual lado desvia</li>
        <li>Se desvia para <strong>DIREITA</strong>: use <code>atrasar_mote 30</code></li>
        <li>Se desvia para <strong>ESQUERDA</strong>: use <code>atrasar_motd 30</code></li>
        <li>Teste novamente e ajuste o valor (10-100)</li>
        <li>A calibracao e salva automaticamente na EEPROM!</li>
    </ol>

    <!-- SECAO 14 -->
    <h1 id="velocidades">14. Configuracao de Velocidades (Upgrade 5.2)</h1>

    <p>Na versao 5.1, a forma mais previsivel de reduzir a velocidade e usar <strong>tempos menores</strong> nos comandos e pausas <code>t</code> entre movimentos.</p>
    <p>O ajuste completo de velocidades (movimento, linha e ultrassom) faz parte do <strong>Upgrade 5.2</strong>, descrito na Secao 18.</p>

    <!-- SECAO 15 -->
    <h1 id="referencia">15. Tabela de Referencia Rapida</h1>
    <div class="mission-header">
        <div>
            <div class="mission-name">Missao: Consulta Rapida</div>
            <div class="mission-goal">Objetivo: Usar tabela</div>
            <div class="mission-reward">Selo: Rapido</div>
        </div>
        <div class="mission-badges"><span class="mission-badge">Consulta</span></div>
    </div>

    <table>
        <tr><th>Categoria</th><th>Comando</th><th>Descricao</th></tr>
        <tr><td rowspan="4">Movimento</td><td><code>pf &lt;ms&gt;</code></td><td>Para frente</td></tr>
        <tr><td><code>pt &lt;ms&gt;</code></td><td>Para tras</td></tr>
        <tr><td><code>pd &lt;ms&gt;</code></td><td>Gira direita</td></tr>
        <tr><td><code>pe &lt;ms&gt;</code></td><td>Gira esquerda</td></tr>
        <tr><td rowspan="3">LEDs</td><td><code>ld &lt;ms&gt;</code></td><td>LED direito</td></tr>
        <tr><td><code>le &lt;ms&gt;</code></td><td>LED esquerdo</td></tr>
        <tr><td><code>lde &lt;ms&gt;</code></td><td>Ambos LEDs</td></tr>
        <tr><td rowspan="4">Garra</td><td><code>bc</code></td><td>Baixar/Fechar</td></tr>
        <tr><td><code>sc</code></td><td>Subir/Abrir</td></tr>
        <tr><td><code>servo1 &lt;ang&gt;</code></td><td>Garra (servo 1)</td></tr>
        <tr><td><code>servo2 &lt;ang&gt;</code></td><td>Braco (servo 2)</td></tr>
        <tr><td>Som</td><td><code>bu &lt;ms&gt;</code></td><td>Buzzer</td></tr>
        <tr><td>Pausa</td><td><code>t &lt;ms&gt;</code></td><td>Pausa silenciosa</td></tr>
        <tr><td rowspan="3">Sensores</td><td><code>sensor linha</code></td><td>Ativa IR</td></tr>
        <tr><td><code>sensor ultra</code></td><td>Ativa ultrassom</td></tr>
        <tr><td><code>sensor off</code></td><td>Desativa</td></tr>
        <tr><td>Linha</td><td><code>seguir-linha &lt;ms&gt;</code></td><td>Segue linha</td></tr>
        <tr><td>Ultra</td><td><code>seguir-ultra &lt;ms&gt;</code></td><td>Desvia obstaculos</td></tr>
        <tr><td rowspan="3">Velocidades</td><td><code>define_vel &lt;valor&gt;</code></td><td>Velocidade geral</td></tr>
        <tr><td><code>define_vel_linha &lt;valor&gt;</code></td><td>Velocidade linha</td></tr>
        <tr><td><code>define_vel_ultra &lt;valor&gt;</code></td><td>Velocidade ultra</td></tr>
        <tr><td rowspan="2">Calibracao</td><td><code>atrasar_mote &lt;valor&gt;</code></td><td>Atrasa motor esquerdo</td></tr>
        <tr><td><code>atrasar_motd &lt;valor&gt;</code></td><td>Atrasa motor direito</td></tr>
    </table>

    <h2>Valores Padrao</h2>
    <table>
        <tr><th>Parametro</th><th>Valor</th></tr>
        <tr><td>PWM Padrao Movimento</td><td>700</td></tr>
        <tr><td>PWM Padrao Linha</td><td>700</td></tr>
        <tr><td>PWM Padrao Ultra</td><td>800</td></tr>
        <tr><td>Passo Padrao (sem tempo)</td><td>120ms</td></tr>
        <tr><td>LED Padrao</td><td>500ms</td></tr>
        <tr><td>Buzzer Padrao</td><td>800ms</td></tr>
        <tr><td>Distancia Obstaculo</td><td>20cm</td></tr>
        <tr><td>Tempo Giro</td><td>200ms</td></tr>
    </table>

    <!-- SECAO 16 -->
    <h1 id="exemplos">16. Exemplos Praticos Completos</h1>
    <div class="mission-header">
        <div>
            <div class="mission-name">Missao: Programas Completos</div>
            <div class="mission-goal">Objetivo: Fazer um projeto</div>
            <div class="mission-reward">Selo: Criador</div>
        </div>
        <div class="mission-badges"><span class="mission-badge">Projeto</span></div>
    </div>

    <h2>Quadrado com LEDs</h2>
    <div class="pje-example">
        <div class="pje-label">Modulo 2/4</div>
        <div class="pje-textarea"><pre>pf 1000
t 50
ld 300
t 50
pd 220
t 50
pf 1000
t 50
le 300
t 50
pd 220
t 50
pf 1000
t 50
ld 300
t 50
pd 220
t 50
pf 1000
t 50
le 300
t 50
pd 220
bu 1000</pre></div>
        <div class="pje-send">ENVIAR</div>
    </div>

    <h2>Seguidor de Linha</h2>
    <div class="pje-example">
        <div class="pje-label">Modulo 4</div>
        <div class="pje-textarea"><pre>sensor linha
repita 300
  seguir-linha 100
  t 50
fim repita
sensor off
bu 500
lde 1000</pre></div>
        <div class="pje-send">ENVIAR</div>
    </div>

    <h2>Seguidor de Linha com Deteccao</h2>
    <div class="pje-example">
        <div class="pje-label">Modulo 4</div>
        <div class="pje-textarea"><pre>sensor linha
repita 200
  seguir-linha 50
  t 50
  se perdeu
    bu 200
    lde 200
  fim se
fim repita
sensor off</pre></div>
        <div class="pje-send">ENVIAR</div>
    </div>

    <h2>Explorador Ultrassonico (sensor de distancia)</h2>
    <div class="pje-example">
        <div class="pje-label">Modulo 4</div>
        <div class="pje-textarea"><pre>sensor ultra
repita 30
  seguir-ultra 2000
  t 50
fim repita
sensor off
lde 500
bu 300
bu 300
bu 300</pre></div>
        <div class="pje-send">ENVIAR</div>
    </div>
    <div class="box box-info">
        <p><strong>Legenda rapida:</strong> <code>sensor ultra</code> ativa o sensor | <code>seguir-ultra</code> faz navegacao automatica | <code>t 50</code> pausa silenciosa | <code>lde</code> pisca LEDs | <code>bu</code> sinal sonoro</p>
    </div>

    <h3>Personalidade 1: Cauteloso (Desvia com calma)</h3>
    <div class="shape-diagram">[ ]  ->  [ ]  ->  [ ]  (passos curtos e pausas)</div>
    <div class="pje-example">
        <div class="pje-label">Modulo 4</div>
        <div class="pje-textarea"><pre>sensor ultra
repita 50
  se dist 20
    bu 100
    pt 200
    t 50
    pd 200
    t 50
  fim se
  pf 200
  t 50
fim repita
sensor off
bu 500</pre></div>
        <div class="pje-send">ENVIAR</div>
    </div>
    <div class="box box-info">
        <p><strong>Legenda rapida:</strong> <code>dist 20</code> = distancia &lt;= 20 <strong>cm</strong> (obstaculo perto) | <code>pt</code> recua | <code>pd</code> gira | <code>pf</code> avanca | <code>t 50</code> estabiliza</p>
    </div>

    <h3>Personalidade 2: Explorer (Avanca mais e corrige)</h3>
    <div class="shape-diagram">---->  /  ---->  \\  ---->  (exploracao ativa)</div>
    <div class="pje-example">
        <div class="pje-label">Modulo 4</div>
        <div class="pje-textarea"><pre>sensor ultra
repita 60
  se dist 25
    bu 100
    pt 150
    t 50
    pe 220
    t 50
  fim se
  pf 300
  t 50
fim repita
sensor off
bu 500</pre></div>
        <div class="pje-send">ENVIAR</div>
    </div>
    <div class="box box-info">
        <p><strong>Legenda rapida:</strong> <code>dist 25</code> = distancia &lt;= 25 <strong>cm</strong> (mais espaco antes de virar) | <code>pe</code> gira esquerda | <code>pf 300</code> avanca mais</p>
    </div>

    <h3>Personalidade 3: Labirinto (Alterna lados)</h3>
    <div class="shape-diagram">|_| -> |_| -> |_|  (vira para testar saidas)</div>
    <div class="pje-example">
        <div class="pje-label">Modulo 4</div>
        <div class="pje-textarea"><pre>sensor ultra
repita 40
  se dist 15
    bu 100
    pt 200
    t 50
    pd 200
    t 50
  fim se
  se distm 15
    pf 200
    t 50
  fim se
fim repita
sensor off
bu 500</pre></div>
        <div class="pje-send">ENVIAR</div>
    </div>
    <div class="box box-info">
        <p><strong>Legenda rapida:</strong> <code>distm 15</code> = distancia &gt;= 15 <strong>cm</strong> (caminho livre) | combina desvio e avance</p>
    </div>

    <h2>Coletor de Objetos</h2>
    <div class="pje-example">
        <div class="pje-label">Modulo 2/4</div>
        <div class="pje-textarea"><pre>sc              # Abre garra
t 50
pf 1500         # Aproxima
t 50
bc              # Pega objeto
t 50
pt 1500         # Recua
t 50
sc              # Solta
bu 500</pre></div>
        <div class="pje-send">ENVIAR</div>
    </div>

    <h2>Navegacao com Condicoes</h2>
    <div class="pje-example">
        <div class="pje-label">Modulo 4</div>
        <div class="pje-textarea"><pre>sensor ultra
repita 50
  se dist 15
    bu 100
    pt 200
    t 50
    pd 200
    t 50
  fim se
  pf 200
  t 50
fim repita
sensor off
bu 500</pre></div>
        <div class="pje-send">ENVIAR</div>
    </div>
    <div class="box box-info">
        <p><strong>Legenda rapida:</strong> <code>dist 15</code> = distancia &lt;= 15 <strong>cm</strong> (obstaculo perto) -> recua e gira | caminho livre -> avanca</p>
    </div>

    <!-- SECAO 17 -->
    <h1 id="problemas">17. Resolucao de Problemas</h1>

    <div class="box box-info">
        <h3>Calma, isso e normal</h3>
        <p>Se algo nao funcionar, respire e siga o passo a passo. Quase sempre e cabo, ID ou Wi‑Fi.</p>
    </div>

    <div class="mission-header">
        <div>
            <div class="mission-name">Missao: Resolver</div>
            <div class="mission-goal">Objetivo: Encontrar o erro</div>
            <div class="mission-reward">Selo: Socorro</div>
        </div>
        <div class="mission-badges"><span class="mission-badge">Ajuda</span></div>
    </div>
    <img class="module-img didactic-img" src="assets_full/16_problemas.png" alt="Checklist de problemas">
    <div class="module-caption">Checklist rapido para resolver problemas</div>

    <div class="box box-danger">
        <h3>Robo nao conecta ao WiFi</h3>
        <p><strong>Sintoma:</strong> LED pisca muito rapido continuamente</p>
        <p><strong>Solucoes:</strong> Verifique WiFi, alcance, senha no programa do robo (firmware), reinicie</p>
    </div>

    <div class="box box-warning">
        <h3>Robo desvia para um lado</h3>
        <p><strong>Solucao:</strong> Calibracao dos motores</p>
        <ul>
            <li>Desvia para DIREITA: <code>atrasar_mote 30</code></li>
            <li>Desvia para ESQUERDA: <code>atrasar_motd 30</code></li>
        </ul>
    </div>

    <div class="box box-warning">
        <h3>LEDs nao acendem</h3>
        <p><strong>Solucao:</strong> Execute <code>sensor off</code> antes de usar LD/LE/LDE</p>
    </div>

    <div class="box box-danger">
        <h3>Sensor de linha nao funciona</h3>
        <p><strong>Solucoes:</strong></p>
        <ul>
            <li>Verifique se ativou: <code>sensor linha</code></li>
            <li>Verifique conexao fisica dos sensores IR</li>
            <li>Verifique contraste: linha preta em fundo branco</li>
            <li>Ajuste altura dos sensores (1-2cm do chao)</li>
        </ul>
    </div>

    <div class="box box-danger">
        <h3>Sensor ultrassonico (sensor de distancia) nao detecta</h3>
        <p><strong>Solucoes:</strong></p>
        <ul>
            <li>Verifique se ativou: <code>sensor ultra</code></li>
            <li>Verifique conexao (TRIG=D3, ECHO=D8)</li>
            <li>Reduza velocidade: tempos menores ou <code>define_vel_ultra 500</code></li>
            <li>Evite objetos muito finos ou absorventes</li>
        </ul>
    </div>

    <div class="box box-danger">
        <h3>Robo reinicia sozinho</h3>
        <p><strong>Causas:</strong> Bateria fraca, sobrecarga, curto-circuito, sensores conectados durante boot</p>
    </div>

    <!-- SECAO 18 -->
    <h1 id="upgrade52">18. Upgrade 5.2 - Novas Funcoes (Opcional)</h1>
    <div class="mission-header">
        <div>
            <div class="mission-name">Missao: Recursos Extras</div>
            <div class="mission-goal">Objetivo: Conhecer upgrade</div>
            <div class="mission-reward">Selo: Avancado</div>
        </div>
        <div class="mission-badges"><span class="mission-badge">Extra</span></div>
    </div>

    <p>A versao 5.1 foi feita para simplicidade e confiabilidade em sala de aula. Para escolas que desejam mais automacao e recursos avancados, existe a versao 5.2 com modos prontos para navegacao em labirintos e maior variedade de comandos.</p>

    <h2>O que muda na versao 5.2?</h2>
    <ul>
        <li>Modos de sensor de distancia avancados para labirintos</li>
        <li>Comandos prontos para exploracao rapida</li>
        <li>Mais protecoes internas de estabilidade</li>
        <li>Opcoes extras de velocidade personalizada</li>
    </ul>

    <h2>Controle de velocidade (somente no Upgrade 5.2)</h2>
    <p>Na versao 5.2, o professor pode ajustar a velocidade do robo por comando. Na 5.1, use tempos menores e pausas <code>t</code> para diminuir a velocidade continua.</p>
    <table>
        <tr><th>Comando</th><th>Descricao</th></tr>
        <tr><td><code>define_vel &lt;valor&gt;</code></td><td>Define velocidade geral</td></tr>
        <tr><td><code>define_vel_linha &lt;valor&gt;</code></td><td>Define velocidade do seguidor de linha</td></tr>
        <tr><td><code>define_vel_ultra &lt;valor&gt;</code></td><td>Define velocidade do ultrassonico (sensor de distancia)</td></tr>
    </table>
    <div class="pje-example">
        <div class="pje-label">Modulo 2/4</div>
        <div class="pje-textarea"><pre>define_vel 900           # Movimento mais rapido
define_vel 500           # Movimento mais lento
define_vel_linha 600     # Linha mais lenta
define_vel_ultra 700     # Ultra mais lento</pre></div>
        <div class="pje-send">ENVIAR</div>
    </div>

    <h2>Exemplos de comandos disponiveis no upgrade 5.2</h2>
    <pre>seguir-ultra-agil &lt;ms&gt;
seguir-ultra-inteligente &lt;ms&gt;
seguir-ultra-memoria &lt;ms&gt;
seguir-ultra-hibrido &lt;ms&gt;
parar-ultra
define_personalizado &lt;valor&gt;
define_personalizado_linha &lt;valor&gt;
define_personalizado_ultra &lt;valor&gt;
reset_personalizado</pre>

    <p><strong>Recomendacao para professores:</strong> se o foco for labirintos avancados e navegacao autonoma mais inteligente, vale solicitar o upgrade 5.2.</p>

    <!-- SECAO 19 -->
    <h1 id="glossario">19. Glossario</h1>
    <div class="mission-header">
        <div>
            <div class="mission-name">Missao: Palavras Simples</div>
            <div class="mission-goal">Objetivo: Entender termos</div>
            <div class="mission-reward">Selo: Vocabulário</div>
        </div>
        <div class="mission-badges"><span class="mission-badge">Glossario</span></div>
    </div>

    <table>
        <tr><th>Termo</th><th>Definicao</th></tr>
        <tr><td>Boot</td><td>Inicializacao quando liga</td></tr>
        <tr><td>Buzzer</td><td>Componente que emite sons/bipes</td></tr>
        <tr><td>EEPROM</td><td>Memoria que mantem dados apos desligar</td></tr>
        <tr><td>ESP8266</td><td>O “cerebro” que tem Wi‑Fi dentro</td></tr>
        <tr><td>GPIO</td><td>Pinos programaveis de entrada/saida</td></tr>
        <tr><td>HC-SR04</td><td>Modelo do sensor de distancia (ultrassonico)</td></tr>
        <tr><td>Heartbeat</td><td>Pulso periodico do LED indicando saude</td></tr>
        <tr><td>IR</td><td>Infravermelho - tecnologia dos sensores de linha</td></tr>
        <tr><td>LED</td><td>Light Emitting Diode - os "olhos" do robo</td></tr>
        <tr><td>PJE</td><td>Plataforma Jabuti Edu - sistema de controle online</td></tr>
        <tr><td>PWM</td><td>Controle de potencia dos motores</td></tr>
        <tr><td>Rampa</td><td>Sistema de aceleracao/desaceleracao suave</td></tr>
        <tr><td>Servo</td><td>Motor de posicionamento preciso (garra)</td></tr>
        <tr><td>t (Tempo)</td><td>Comando de pausa silenciosa em milissegundos (ms)</td></tr>
        <tr><td>Ultrassonico (sensor de distancia)</td><td>Sensor que mede distancia por ondas sonoras</td></tr>
        <tr><td>Watchdog</td><td>Sistema que reinicia se travar</td></tr>
        <tr><td>WiFi</td><td>Conexao sem fio para internet</td></tr>
        <tr><td>Wemos D1 Mini</td><td>A plaquinha do robô onde o “cerebro” mora</td></tr>
        <tr><td>yield()</td><td>Funcao que alimenta o watchdog</td></tr>
    </table>

    <hr style="margin-top: 50px;">
    <div style="text-align: center; color: #666; padding: 20px;">
        <p><strong>EJR Robotica Educacional</strong></p>
        <p>WhatsApp: 51 99292 1288 | Email: eloirjr@gmail.com</p>
        <p>Plataforma: pje.ejrrobotica.com.br</p>
        <p style="font-size: 9pt;">Versao do Documento: 1.0 | Firmware: MostraBot 5em1 v5.1 | Janeiro 2026</p>
    </div>

</main>

<div class="quick-exit" id="quick-exit">
    <button class="mode-btn" type="button" id="exit-presentation">Sair da Apresentacao (Esc)</button>
</div>

<div class="student-step-nav" id="student-step-nav">
    <span class="student-step-label" id="student-step-label">Passo 1 de 1</span>
</div>

<div class="student-fab-nav" id="student-fab-nav">
    <button class="student-fab-btn student-fab-prev" type="button" id="student-fab-prev" aria-label="Passo anterior">◀</button>
    <button class="student-fab-btn student-fab-next" type="button" id="student-fab-next" aria-label="Proximo passo">▶</button>
</div>

<div class="robot-dialog-backdrop" id="robot-dialog" hidden>
    <div class="robot-dialog" role="dialog" aria-modal="true" aria-labelledby="robot-dialog-title">
        <h3 id="robot-dialog-title">MostraBot diz:</h3>
        <p>Respira fundo. Vamos em 3 passos: ligar robo, entrar na PJE, testar 1 comando.</p>
        <p>Se travar, volte uma fase e tente de novo. Errar faz parte do jogo.</p>
        <p>Objetivo de agora: concluir a tarefa atual e clicar em "Finalizar missao".</p>
        <div class="robot-dialog-actions">
            <button class="mode-btn" type="button" id="robot-dialog-close">Entendi</button>
        </div>
    </div>
</div>


<script>
(function() {
  const main = document.querySelector('main');
  if (!main) return;
  const headers = Array.from(main.querySelectorAll('h1'));
  const skipIds = new Set(['mapa-jogo']);
  const navLinks = Array.from(document.querySelectorAll('nav a[href^="#"]'));
  const missionCards = Array.from(document.querySelectorAll('.mission-card[data-target]'));
  const lessonCards = Array.from(document.querySelectorAll('.lesson-card[data-aula]'));
  const progressFill = document.querySelector('.progress-fill');
  const hudMission = document.getElementById('hud-missao');
  const hudAula = document.getElementById('hud-aula');
  const hudModulo = document.getElementById('hud-modulo');
  const hudSecao = document.getElementById('hud-secao');
  const hudModo = document.getElementById('hud-modo');
  const hudUnlock = document.getElementById('hud-unlock');
  const hudCompleted = document.getElementById('hud-completed');
  const focusChips = Array.from(document.querySelectorAll('.focus-chip'));
  const modeButtons = Array.from(document.querySelectorAll('.mode-btn[data-mode]'));
  const stageButtons = Array.from(document.querySelectorAll('[data-stage-nav]'));
  const exitPresentationBtn = document.getElementById('exit-presentation');
  const roadmapPanel = document.querySelector('.roadmap-panel');
  const studentStepNav = document.getElementById('student-step-nav');
  const studentStepPrev = document.getElementById('student-step-prev');
  const studentStepNext = document.getElementById('student-step-next');
  const studentStepLabel = document.getElementById('student-step-label');
  const studentFabPrev = document.getElementById('student-fab-prev');
  const studentFabNext = document.getElementById('student-fab-next');
  const robotGuideTrigger = document.getElementById('robot-guide-trigger');
  const robotDialog = document.getElementById('robot-dialog');
  const robotDialogClose = document.getElementById('robot-dialog-close');
  const ageSelect = document.getElementById('age-select');
  const backStageBtn = document.getElementById('back-stage-btn');
  const completeStageBtn = document.getElementById('complete-stage-btn');
  const resetProgressBtn = document.getElementById('reset-progress-btn');
  const profChecklistItems = document.getElementById('prof-checklist-items');
  const stageOrder = ['intro', 'ligar-robo', 'led', 'movimento', 'buzzer', 'servo', 'linha'];
  const slideIndexBySection = {};
  const TASK_PROGRESS_SCHEMA = 'v4';
  let currentAge = '9-11';
  const defaultGameConfig = {
    version: 1,
    studentMissionCount: 7,
    professorChecklist: [
      'Conferir bateria e ID na fita amarela',
      'Confirmar acesso a internet e PJE aberta',
      'Validar login com senha 123',
      'Selecionar modulo correto da missao',
      'Executar demonstracao curta antes da turma',
      'Registrar quais alunos concluiram a fase'
    ]
  };
  let gameConfig = defaultGameConfig;

  const moduleLabel = {
    m1: 'Modulo 1',
    m2: 'Modulo 2',
    m4: 'Modulo 4',
    support: 'Suporte',
    all: 'Todos'
  };

  const missionBySection = {
    'mapa-jogo': { name: 'Missao 0', module: 'm1', order: 0 },
    intro: { name: 'Missao 0', module: 'm1', order: 0 },
    aulas: { name: 'Plano do Professor', module: 'support', order: 0 },
    'primeiros-passos': { name: 'Missao 1', module: 'm1', order: 1 },
    'ligar-robo': { name: 'Missao 1', module: 'm1', order: 1 },
    led: { name: 'Missao 2', module: 'm1', order: 2 },
    movimento: { name: 'Missao 3', module: 'm1', order: 3 },
    buzzer: { name: 'Missao 4', module: 'm1', order: 4 },
    servo: { name: 'Missao 5', module: 'm2', order: 5 },
    linha: { name: 'Missao 6', module: 'm4', order: 6 },
    ultra: { name: 'Missao 6', module: 'm4', order: 6 },
    controle: { name: 'Missao 6', module: 'm4', order: 6 },
    condicoes: { name: 'Missao 6', module: 'm4', order: 6 },
    calibracao: { name: 'Missao 6', module: 'm4', order: 6 },
    velocidades: { name: 'Missao 6', module: 'm4', order: 6 },
    referencia: { name: 'Missao 6', module: 'm4', order: 6 },
    exemplos: { name: 'Missao 6', module: 'm4', order: 6 },
    problemas: { name: 'Missao 6', module: 'm4', order: 6 },
    upgrade52: { name: 'Missao 6', module: 'm4', order: 6 },
    glossario: { name: 'Missao 6', module: 'm4', order: 6 }
  };

  function getUnlockKey() {
    return 'mostrabot_unlock_' + currentAge;
  }

  function getCompletedKey() {
    return 'mostrabot_completed_' + currentAge;
  }

  function getChecklistKey() {
    return 'mostrabot_prof_checklist';
  }
  function getTaskProgressKey() {
    return 'mostrabot_task_progress_' + TASK_PROGRESS_SCHEMA + '_' + currentAge;
  }
  function getReadOnceKey() {
    return 'mostrabot_slide_read_once_v2_' + currentAge;
  }

  function sortMissionCardsByOrder() {
    const grid = document.querySelector('.mission-grid');
    if (!grid) return;
    const cards = Array.from(grid.querySelectorAll('.mission-card[data-order]'));
    cards.sort((a, b) => Number(a.dataset.order || '0') - Number(b.dataset.order || '0'));
    cards.forEach((card) => grid.appendChild(card));
  }

  function getTaskProgress() {
    try {
      const raw = localStorage.getItem(getTaskProgressKey());
      const parsed = raw ? JSON.parse(raw) : {};
      return parsed && typeof parsed === 'object' ? parsed : {};
    } catch (error) {
      return {};
    }
  }

  function setTaskProgress(progress) {
    try {
      localStorage.setItem(getTaskProgressKey(), JSON.stringify(progress || {}));
    } catch (error) {}
  }
  function toSafeId(value) {
    return String(value || '').replace(/[^a-zA-Z0-9_-]/g, '-');
  }

  function getReadOnceProgress() {
    try {
      const raw = localStorage.getItem(getReadOnceKey());
      const parsed = raw ? JSON.parse(raw) : {};
      return parsed && typeof parsed === 'object' ? parsed : {};
    } catch (error) {
      return {};
    }
  }

  function setReadOnceProgress(progress) {
    try {
      localStorage.setItem(getReadOnceKey(), JSON.stringify(progress || {}));
    } catch (error) {}
  }

  function getReadToken(sectionId, slideIndex) {
    return sectionId + '::' + String(slideIndex);
  }

  function getUnlockedStage() {
    try {
      const raw = localStorage.getItem(getUnlockKey());
      const val = Number(raw);
      if (Number.isInteger(val)) return Math.max(0, Math.min(stageOrder.length - 1, val));
    } catch (error) {}
    return 0;
  }

  function setUnlockedStage(nextValue) {
    const safe = Math.max(0, Math.min(stageOrder.length - 1, Number(nextValue) || 0));
    try {
      localStorage.setItem(getUnlockKey(), String(safe));
    } catch (error) {}
    if (hudUnlock) hudUnlock.textContent = String(safe);
  }

  function getCompletedMissions() {
    try {
      const raw = localStorage.getItem(getCompletedKey());
      const parsed = raw ? JSON.parse(raw) : [];
      if (Array.isArray(parsed)) return parsed.filter((n) => Number.isInteger(n));
    } catch (error) {}
    return [];
  }

  function setCompletedMissions(values) {
    const unique = Array.from(new Set((values || []).filter((n) => Number.isInteger(n))));
    try {
      localStorage.setItem(getCompletedKey(), JSON.stringify(unique));
    } catch (error) {}
    if (hudCompleted) hudCompleted.textContent = String(unique.length);
  }

  function renderProfessorChecklist() {
    if (!profChecklistItems) return;
    profChecklistItems.innerHTML = '';
    const saved = (() => {
      try {
        const raw = localStorage.getItem(getChecklistKey());
        return raw ? JSON.parse(raw) : {};
      } catch (error) {
        return {};
      }
    })();

    (gameConfig.professorChecklist || []).forEach((itemText, idx) => {
      const row = document.createElement('label');
      row.className = 'prof-checklist-item';
      const input = document.createElement('input');
      input.type = 'checkbox';
      input.checked = Boolean(saved[idx]);
      input.addEventListener('change', () => {
        saved[idx] = input.checked;
        try {
          localStorage.setItem(getChecklistKey(), JSON.stringify(saved));
        } catch (error) {}
      });
      const text = document.createElement('span');
      text.textContent = itemText;
      row.appendChild(input);
      row.appendChild(text);
      profChecklistItems.appendChild(row);
    });
  }

  async function loadGameConfig() {
    try {
      const response = await fetch('data/game-config.json', { cache: 'no-store' });
      if (!response.ok) return;
      const loaded = await response.json();
      if (loaded && typeof loaded === 'object') {
        gameConfig = Object.assign({}, defaultGameConfig, loaded);
      }
    } catch (error) {
      gameConfig = defaultGameConfig;
    }
    renderProfessorChecklist();
  }

  function toSectionName(id) {
    const h1 = document.getElementById(id);
    if (!h1) return '-';
    return h1.textContent.trim();
  }

  function openSectionFromTarget(targetEl) {
    if (!targetEl) return;
    if (targetEl.tagName === 'H1') {
      const ownContent = targetEl.nextElementSibling;
      if (ownContent && ownContent.classList.contains('lesson-content')) {
        ownContent.classList.remove('collapsed');
        targetEl.classList.remove('collapsed');
      }
      return;
    }
    const content = targetEl.closest('.lesson-content');
    if (!content) return;
    const title = content.previousElementSibling;
    if (!title || title.tagName !== 'H1') return;
    content.classList.remove('collapsed');
    title.classList.remove('collapsed');
  }

  headers.forEach((h1) => {
    if (skipIds.has(h1.id)) return;
    if (h1.classList.contains('lesson-toggle')) return;

    h1.classList.add('lesson-toggle');

    // Collect nodes until next h1
    const content = document.createElement('div');
    content.className = 'lesson-content';
    let node = h1.nextElementSibling;
    while (node && node.tagName !== 'H1') {
      const next = node.nextElementSibling;
      content.appendChild(node);
      node = next;
    }
    h1.insertAdjacentElement('afterend', content);
  });

  // Add hint after map
  const map = document.getElementById('mapa-jogo');
  if (map && !document.getElementById('lesson-hint')) {
    const hint = document.createElement('div');
    hint.id = 'lesson-hint';
    hint.className = 'lesson-hint';
    hint.textContent = 'Clique no titulo de cada secao para abrir e fechar.';
    map.insertAdjacentElement('afterend', hint);
  }

  // Collapse all except map, aulas e intro
  headers.forEach((h1) => {
    if (h1.id === 'mapa-jogo' || h1.id === 'aulas' || h1.id === 'intro') return;
    const content = h1.nextElementSibling;
    if (content && content.classList.contains('lesson-content')) {
      content.classList.add('collapsed');
      h1.classList.add('collapsed');
    }
  });

  main.addEventListener('click', (e) => {
    const h1 = e.target.closest('.lesson-toggle');
    if (!h1) return;
    const content = h1.nextElementSibling;
    if (!content || !content.classList.contains('lesson-content')) return;
    const isCollapsed = content.classList.toggle('collapsed');
    h1.classList.toggle('collapsed', isCollapsed);
  });

  function enhanceCodeExamples() {
    const blocks = Array.from(document.querySelectorAll('.pje-example'));
    blocks.forEach((block) => {
      if (block.querySelector('.copy-code-btn')) return;
      const pre = block.querySelector('.pje-textarea pre');
      if (!pre) return;
      const tools = document.createElement('div');
      tools.className = 'pje-tools';
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'copy-code-btn';
      btn.textContent = 'Copiar codigo';
      const status = document.createElement('span');
      status.className = 'copy-status';
      status.textContent = '';

      btn.addEventListener('click', async () => {
        const code = pre.textContent || '';
        try {
          await navigator.clipboard.writeText(code);
          status.textContent = 'Copiado!';
        } catch (error) {
          status.textContent = 'Nao foi possivel copiar.';
        }
        setTimeout(() => {
          status.textContent = '';
        }, 1500);
      });

      tools.appendChild(btn);
      tools.appendChild(status);
      const send = block.querySelector('.pje-send');
      if (send) {
        send.insertAdjacentElement('beforebegin', tools);
      } else {
        block.appendChild(tools);
      }
    });
  }

  function enforceExternalPjeLinks() {
    const links = Array.from(document.querySelectorAll('a[href^="https://pje.ejrrobotica.com.br"]'));
    links.forEach((link) => {
      link.setAttribute('target', '_blank');
      link.setAttribute('rel', 'noopener noreferrer');
      if (link.dataset.pjeBound === '1') return;
      link.dataset.pjeBound = '1';
      link.addEventListener('click', (event) => {
        event.preventDefault();
        window.open(link.href, '_blank', 'noopener,noreferrer');
      });
    });
  }

  function getSectionIdFromMissionTask(taskBox) {
    const content = taskBox.closest('.lesson-content');
    if (!content) return null;
    const h1 = content.previousElementSibling;
    if (!h1 || h1.tagName !== 'H1') return null;
    return h1.id || null;
  }

  function renderMissionTaskState(taskBox, taskKey, taskState) {
    const items = Array.from(taskBox.querySelectorAll('.task-row'));
    items.forEach((row, idx) => {
      if (!row.dataset.taskId) {
        row.dataset.taskId = taskKey + '::task::' + String(idx);
      }
    });
    if (!taskState || typeof taskState !== 'object') taskState = {};
    taskState.taskMap = taskState.taskMap && typeof taskState.taskMap === 'object' ? taskState.taskMap : {};
    if (Array.isArray(taskState.tasks)) {
      items.forEach((row, idx) => {
        if (!taskState.tasks[idx]) return;
        const legacyId = row.dataset.taskId || ('legacy-' + String(idx));
        taskState.taskMap[legacyId] = true;
      });
    }
    const firstPending = items.findIndex((row) => !Boolean(taskState.taskMap[row.dataset.taskId || '']));
    const activeIndex = firstPending === -1 ? -1 : firstPending;

    items.forEach((row, idx) => {
      const taskId = row.dataset.taskId || '';
      const done = Boolean(taskState.taskMap[taskId]);
      const visible = activeIndex === -1 ? true : done || idx === activeIndex;
      row.classList.toggle('task-row-hidden', !visible);
      row.classList.toggle('done', done);
      const btn = row.querySelector('.task-complete-btn');
      if (btn) {
        btn.classList.toggle('done', done);
        btn.textContent = done ? 'Tarefa concluida' : 'Clique para prosseguir';
      }
    });

    const finishBtn = taskBox.querySelector('.mission-finish-btn');
    const finishState = taskBox.querySelector('.mission-finish-state');
    const allDone = items.length > 0 && items.every((row) => Boolean(taskState.taskMap[row.dataset.taskId || '']));
    if (finishBtn) {
      finishBtn.disabled = !allDone || Boolean(taskState.finished);
      finishBtn.classList.toggle('done', Boolean(taskState.finished));
      finishBtn.textContent = taskState.finished ? 'Missao finalizada' : 'Finalizar missao e continuar';
    }
    if (finishState) {
      if (taskState.finished) finishState.textContent = 'Missao finalizada! Historia concluida.';
      else if (allDone) finishState.textContent = 'Clique em "Finalizar missao" para liberar a proxima fase.';
      else finishState.textContent = '';
    }
  }

  function enhanceMissionTasks() {
    const boxes = Array.from(document.querySelectorAll('.mission-task'));
    const taskCounterBySection = {};

    boxes.forEach((box) => {
      if (box.dataset.ldified === '1') return;
      const sectionId = getSectionIdFromMissionTask(box);
      if (!sectionId) return;
      box.dataset.ldified = '1';
      box.dataset.sectionId = sectionId;
      const localIndex = taskCounterBySection[sectionId] || 0;
      const taskKey = sectionId + '::' + String(localIndex);
      taskCounterBySection[sectionId] = localIndex + 1;
      box.dataset.taskKey = taskKey;

      const list = box.querySelector('ol');
      const liItems = list ? Array.from(list.querySelectorAll('li')) : [];
      if (liItems.length === 0) {
        const synthetic = document.createElement('div');
        synthetic.className = 'task-row';
        synthetic.innerHTML = '<span class="task-text">Ler e entender esta etapa.</span><span class="task-help">Clique no botao abaixo para prosseguir na historia.</span>';
        synthetic.dataset.taskId = taskKey + '::task::0';
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'task-complete-btn';
        btn.id = 'task-btn-' + toSafeId(taskKey) + '-0';
        btn.textContent = 'Clique para prosseguir';
        synthetic.appendChild(btn);
        box.appendChild(synthetic);
      } else {
        liItems.forEach((li, idx) => {
          const row = document.createElement('div');
          row.className = 'task-row';
          const text = document.createElement('span');
          text.className = 'task-text';
          text.innerHTML = li.innerHTML;
          const help = document.createElement('span');
          help.className = 'task-help';
          help.textContent = 'Clique no botao abaixo para prosseguir na historia.';
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'task-complete-btn';
          btn.id = 'task-btn-' + toSafeId(taskKey) + '-' + String(idx);
          btn.textContent = 'Clique para prosseguir';
          row.appendChild(text);
          row.appendChild(help);
          row.appendChild(btn);
          li.replaceWith(row);
          row.dataset.taskId = taskKey + '::task::' + String(idx);
        });
      }

      const finishWrap = document.createElement('div');
      finishWrap.className = 'mission-finish-wrap';
      const finishBtn = document.createElement('button');
      finishBtn.type = 'button';
      finishBtn.className = 'mission-finish-btn';
      finishBtn.id = 'finish-btn-' + toSafeId(taskKey);
      finishBtn.textContent = 'Finalizar missao e continuar';
      finishBtn.disabled = true;
      const finishState = document.createElement('span');
      finishState.className = 'mission-finish-state';
      finishWrap.appendChild(finishBtn);
      finishWrap.appendChild(finishState);
      box.appendChild(finishWrap);

      box.addEventListener('click', (event) => {
        const taskBtn = event.target.closest('.task-complete-btn');
        if (taskBtn) {
          const row = taskBtn.closest('.task-row');
          const taskId = row ? row.dataset.taskId || '' : '';
          const progress = getTaskProgress();
          progress[taskKey] = progress[taskKey] || { taskMap: {}, finished: false };
          progress[taskKey].taskMap = progress[taskKey].taskMap && typeof progress[taskKey].taskMap === 'object'
            ? progress[taskKey].taskMap
            : {};
          if (taskId) progress[taskKey].taskMap[taskId] = true;
          setTaskProgress(progress);
          renderMissionTaskState(box, taskKey, progress[taskKey]);
          return;
        }

        const mBtn = event.target.closest('.mission-finish-btn');
        if (mBtn) {
          const info = missionBySection[sectionId];
          const currentIdx = info ? info.order : 0;
          const progress = getTaskProgress();
          progress[taskKey] = progress[taskKey] || { taskMap: {}, finished: false };
          progress[taskKey].finished = true;
          setTaskProgress(progress);

          const completed = getCompletedMissions();
          if (!completed.includes(currentIdx)) {
            completed.push(currentIdx);
            setCompletedMissions(completed);
          }

          const unlocked = getUnlockedStage();
          if (currentIdx <= unlocked && unlocked < stageOrder.length - 1) {
            const nextUnlocked = unlocked + 1;
            setUnlockedStage(nextUnlocked);
            window.location.hash = '#' + (stageOrder[nextUnlocked] || 'intro');
          }
          applyStudentLocks();
          refreshStudentActionButton();
          applyStudentSingleScreen();
          renderMissionTaskState(box, taskKey, progress[taskKey]);
        }
      });
    });

    const progress = getTaskProgress();
    boxes.forEach((box) => {
      const taskKey = box.dataset.taskKey;
      if (!taskKey) return;
      progress[taskKey] = progress[taskKey] || { taskMap: {}, finished: false };
      renderMissionTaskState(box, taskKey, progress[taskKey]);
    });
  }

  function refreshMissionTaskStates() {
    const progress = getTaskProgress();
    const boxes = Array.from(document.querySelectorAll('.mission-task[data-section-id]'));
    boxes.forEach((box) => {
      const taskKey = box.dataset.taskKey;
      if (!taskKey) return;
      progress[taskKey] = progress[taskKey] || { taskMap: {}, finished: false };
      renderMissionTaskState(box, taskKey, progress[taskKey]);
    });
  }

  missionCards.forEach((card) => {
    const target = card.dataset.target;
    if (!target) return;
    card.addEventListener('click', (event) => {
      const order = Number(card.dataset.order || '0');
      if (document.body.classList.contains('mode-aluno') && order !== getUnlockedStage()) {
        event.preventDefault();
        return;
      }
      const anchor = event.target.closest('a');
      if (anchor) return;
      window.location.hash = '#' + target;
    });
  });

  function setActiveSection(sectionId) {
    if (!sectionId) return;
    navLinks.forEach((a) => {
      const isActive = a.getAttribute('href') === '#' + sectionId;
      a.classList.toggle('active-nav', isActive);
    });

    const missionInfo = missionBySection[sectionId] || missionBySection['mapa-jogo'];
    const order = missionInfo.order;
    const isAluno = document.body.classList.contains('mode-aluno');
    missionCards.forEach((card) => {
      const cardOrder = Number(card.dataset.order || '-1');
      card.classList.toggle('is-active', cardOrder === order);
      card.classList.toggle('is-dimmed', !isAluno && cardOrder > order);
    });
    if (progressFill) {
      progressFill.style.width = (((order + 1) / 7) * 100).toFixed(0) + '%';
    }
    if (hudMission) hudMission.textContent = missionInfo.name;
    if (hudModulo) hudModulo.textContent = moduleLabel[missionInfo.module] || '-';
    if (hudSecao) hudSecao.textContent = toSectionName(sectionId);
  }

  function applyStudentLocks() {
    const isAluno = document.body.classList.contains('mode-aluno');
    const unlocked = getUnlockedStage();
    const completed = getCompletedMissions();
    if (hudUnlock) hudUnlock.textContent = String(unlocked);
    if (hudCompleted) hudCompleted.textContent = String(completed.length);

    missionCards.forEach((card) => {
      const order = Number(card.dataset.order || '0');
      const locked = isAluno && order !== unlocked;
      const complete = completed.includes(order);
      card.classList.toggle('is-locked', locked);
      card.classList.toggle('is-complete', complete);
      const cta = card.querySelector('.cta-button');
      if (cta) {
        if (locked) {
          cta.setAttribute('tabindex', '-1');
          cta.style.pointerEvents = 'none';
        } else {
          cta.removeAttribute('tabindex');
          cta.style.pointerEvents = 'auto';
        }
      }
    });

    navLinks.forEach((link) => {
      const id = (link.getAttribute('href') || '').replace('#', '');
      const info = missionBySection[id];
      const locked = isAluno && info && typeof info.order === 'number' && id !== 'mapa-jogo' && info.order !== unlocked;
      link.classList.toggle('nav-link-locked', Boolean(locked));
    });
    renderAwakeStatusMessage();
  }

  function renderAwakeStatusMessage() {
    const status = document.getElementById('awake-status-msg');
    if (!status) return;
    const completed = getCompletedMissions();
    const unlockedByNextMission = completed.includes(1);
    status.classList.toggle('ready', unlockedByNextMission);
    status.classList.toggle('locked', !unlockedByNextMission);
    status.innerHTML = unlockedByNextMission
      ? 'PRONTO O ROBO ACORDOU COMPLETAMENTE!'
      : 'Mensagem final liberada apos concluir a proxima missao: <strong>Ligar o Robo</strong>.';
  }

  function applyStudentSingleScreen() {
    const isAluno = document.body.classList.contains('mode-aluno');
    const targetId = stageOrder[getUnlockedStage()] || 'intro';

    headers.forEach((h1) => {
      const content = h1.nextElementSibling;
      const keep = !isAluno || h1.id === 'mapa-jogo' || h1.id === targetId;
      h1.classList.toggle('student-single-hidden', !keep);
      if (content && content.classList.contains('lesson-content')) {
        content.classList.toggle('student-single-hidden', !keep);
      }
    });

    if (isAluno) {
      if (window.location.hash.replace('#', '') !== targetId) {
        window.location.hash = '#' + targetId;
      } else {
        setActiveSection(targetId);
      }
    }
  }

  function getStudentSlideGroups(sectionId) {
    const h1 = document.getElementById(sectionId);
    const content = h1 ? h1.nextElementSibling : null;
    if (!content || !content.classList || !content.classList.contains('lesson-content')) return [];

    if (content.dataset.slideGrouped !== '1') {
      const sourceElements = Array.from(content.children).filter((el) => {
        if (!el || !el.tagName) return false;
        if (el.classList.contains('mission-header')) return false;
        return true;
      });

      let currentGroup = null;
      sourceElements.forEach((el) => {
        const startsNewGroup =
          el.tagName === 'H2' ||
          el.classList.contains('mission-task') ||
          el.classList.contains('box') ||
          el.classList.contains('cloud-links');

        if (!currentGroup || (startsNewGroup && currentGroup.childElementCount > 0)) {
          currentGroup = document.createElement('div');
          currentGroup.className = 'student-slide-group';
          content.appendChild(currentGroup);
        }
        currentGroup.appendChild(el);
      });

      content.dataset.slideGrouped = '1';
    }

    return Array.from(content.querySelectorAll('.student-slide-group'));
  }

  function extractContinuationText(group) {
    if (!group) return '';
    const selectors = '.mission-task-title, h2, h3, .lesson-title, p, li, .box h3';
    const candidates = Array.from(group.querySelectorAll(selectors));
    for (let idx = candidates.length - 1; idx >= 0; idx -= 1) {
      const text = (candidates[idx].textContent || '').replace(/\s+/g, ' ').trim();
      if (text.length >= 12) return text.slice(0, 140);
    }
    const fallback = (group.textContent || '').replace(/\s+/g, ' ').trim();
    return fallback ? fallback.slice(0, 140) : '';
  }

  function updateStudentFlowAnchor(groups, currentIndex) {
    groups.forEach((group) => {
      const anchor = group.querySelector('.student-flow-anchor');
      if (anchor) anchor.remove();
    });
    if (currentIndex <= 0) return;
    const prevText = extractContinuationText(groups[currentIndex - 1]);
    if (!prevText) return;
    const currentGroup = groups[currentIndex];
    if (!currentGroup) return;
    const anchor = document.createElement('div');
    anchor.className = 'student-flow-anchor';
    anchor.textContent = 'Continuacao do passo anterior: ' + prevText;
    currentGroup.insertAdjacentElement('afterbegin', anchor);
  }

  function getCurrentStudentSlideState() {
    const sectionId = stageOrder[getUnlockedStage()] || 'intro';
    const groups = getStudentSlideGroups(sectionId);
    if (groups.length === 0) {
      return { sectionId, groups, current: 0, maxIdx: 0, firstTaskIndex: -1, isTaskStep: false };
    }
    const firstTaskIndex = groups.findIndex((group) => group.querySelector('.mission-task'));
    const maxIdx = firstTaskIndex >= 0 ? firstTaskIndex : groups.length - 1;
    const current = Math.max(0, Math.min(maxIdx, Number(slideIndexBySection[sectionId] || 0)));
    const isTaskStep = Boolean(groups[current] && groups[current].querySelector('.mission-task'));
    return { sectionId, groups, current, maxIdx, firstTaskIndex, isTaskStep };
  }

  function hasReadCurrentSlide(state) {
    const readMap = getReadOnceProgress();
    const token = getReadToken(state.sectionId, state.current);
    return Boolean(readMap[token]);
  }

  function updateReadGateByScroll() {
    if (!document.body.classList.contains('mode-aluno')) return;
    const state = getCurrentStudentSlideState();
    if (!state.groups.length) return;
    if (hasReadCurrentSlide(state)) return;
    const currentGroup = state.groups[state.current];
    if (!currentGroup) return;

    const viewport = window.innerHeight || document.documentElement.clientHeight || 0;
    const groupRect = currentGroup.getBoundingClientRect();
    const reachedEndOfGroup = groupRect.bottom <= (viewport - 20);
    const fullyVisibleWithoutScroll = groupRect.top >= 0 && groupRect.bottom <= (viewport - 20);
    if (!reachedEndOfGroup && !fullyVisibleWithoutScroll) return;

    const readMap = getReadOnceProgress();
    readMap[getReadToken(state.sectionId, state.current)] = true;
    setReadOnceProgress(readMap);
    renderStudentSlides();
  }

  function renderStudentSlides() {
    const isAluno = document.body.classList.contains('mode-aluno');
    const sectionId = stageOrder[getUnlockedStage()] || 'intro';
    const groups = getStudentSlideGroups(sectionId);
    const canSlide = Boolean(isAluno && groups.length > 0);

    if (!canSlide) {
      if (studentStepNav) studentStepNav.style.display = 'none';
      document.querySelectorAll('.student-slide-hidden').forEach((el) => el.classList.remove('student-slide-hidden'));
      return;
    }

    if (studentStepNav) studentStepNav.style.display = 'flex';
    const firstTaskIndex = groups.findIndex((group) => group.querySelector('.mission-task'));
    const maxIdx = firstTaskIndex >= 0 ? firstTaskIndex : groups.length - 1;
    const current = Math.max(0, Math.min(maxIdx, Number(slideIndexBySection[sectionId] || 0)));
    slideIndexBySection[sectionId] = current;

    groups.forEach((group, idx) => {
      group.classList.toggle('student-slide-hidden', idx !== current);
    });
    updateStudentFlowAnchor(groups, current);

    const currentElement = groups[current];
    const isTaskStep = Boolean(currentElement && currentElement.querySelector('.mission-task'));
    const taskProgress = getTaskProgress();
    const sectionTaskState = taskProgress[sectionId] || { finished: false };
    const readMap = getReadOnceProgress();
    const readUnlocked = Boolean(readMap[getReadToken(sectionId, current)]);

    let nextDisabledByFlow = current >= maxIdx;
    if (isTaskStep && !sectionTaskState.finished) nextDisabledByFlow = true;
    const nextDisabled = nextDisabledByFlow || !readUnlocked;

    if (studentStepPrev) studentStepPrev.disabled = current <= 0;
    if (studentStepNext) studentStepNext.disabled = nextDisabled;
    if (studentFabPrev) studentFabPrev.disabled = current <= 0;
    if (studentFabNext) {
      studentFabNext.disabled = nextDisabled;
      studentFabNext.classList.toggle('is-read-locked', !readUnlocked);
    }
    if (studentStepLabel) {
      if (!readUnlocked) {
        studentStepLabel.textContent = 'Passo ' + String(current + 1) + ' de ' + String(maxIdx + 1) + ' - Use a seta verde ▶ para continuar';
        studentStepLabel.textContent += ' (se a seta estiver cinza ao lado, desca ate baixo para ler todas as informacoes dessa etapa)';
      } else if (isTaskStep && !sectionTaskState.finished) {
        studentStepLabel.textContent = 'Passo ' + String(current + 1) + ' de ' + String(maxIdx + 1) + ' - Conclua a tarefa abaixo para continuar';
        studentStepLabel.textContent += ' (se a seta estiver cinza ao lado, desca ate baixo para ler todas as informacoes dessa etapa)';
      } else {
        studentStepLabel.textContent = 'Passo ' + String(current + 1) + ' de ' + String(maxIdx + 1) + ' - Use a seta verde ▶ para continuar';
        studentStepLabel.textContent += ' (se a seta estiver cinza ao lado, desca ate baixo para ler todas as informacoes dessa etapa)';
      }
    }
  }

  function changeStudentSlide(delta) {
    if (!document.body.classList.contains('mode-aluno')) return;
    const sectionId = stageOrder[getUnlockedStage()] || 'intro';
    const groups = getStudentSlideGroups(sectionId);
    if (groups.length === 0) return;
    const firstTaskIndex = groups.findIndex((group) => group.querySelector('.mission-task'));
    const maxIdx = firstTaskIndex >= 0 ? firstTaskIndex : groups.length - 1;
    const current = Math.max(0, Math.min(maxIdx, Number(slideIndexBySection[sectionId] || 0)));
    const readMap = getReadOnceProgress();
    const readUnlocked = Boolean(readMap[getReadToken(sectionId, current)]);
    if (delta > 0 && !readUnlocked) return;
    const next = Math.max(0, Math.min(maxIdx, current + delta));
    slideIndexBySection[sectionId] = next;
    renderStudentSlides();
    const currentVisible = groups[next];
    if (currentVisible && typeof currentVisible.scrollIntoView === 'function') {
      currentVisible.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }

  function refreshStudentActionButton() {
    if (!completeStageBtn) return;
    const unlocked = getUnlockedStage();
    completeStageBtn.textContent = unlocked >= stageOrder.length - 1
      ? 'Finalizar missao'
      : 'Completar tarefa e liberar proxima';
  }

  function updateSectionFromScroll() {
    let current = null;
    for (const h1 of headers) {
      const rect = h1.getBoundingClientRect();
      if (rect.top <= 140) current = h1;
    }
    if (!current) current = headers[0];
    if (current && current.id) setActiveSection(current.id);
  }

  function activateLessonCard(card) {
    lessonCards.forEach((c) => c.classList.toggle('active-lesson', c === card));
    if (!card) return;
    if (hudAula) hudAula.textContent = card.dataset.aula || '-';
    const mod = card.dataset.module || 'all';
    if (hudModulo) hudModulo.textContent = moduleLabel[mod] || '-';
  }

  function updateLessonFromScroll() {
    let active = null;
    for (const card of lessonCards) {
      if (card.classList.contains('hidden-by-focus')) continue;
      const rect = card.getBoundingClientRect();
      if (rect.top <= 220 && rect.bottom >= 220) {
        active = card;
        break;
      }
    }
    if (!active) return;
    activateLessonCard(active);
  }

  function getCurrentSectionId() {
    const hashId = window.location.hash.replace('#', '');
    if (hashId && document.getElementById(hashId)) return hashId;
    let current = headers[0] ? headers[0].id : 'mapa-jogo';
    for (const h1 of headers) {
      if (h1.getBoundingClientRect().top <= 140) current = h1.id;
    }
    return current || 'mapa-jogo';
  }

  function getStageIndexFromSection(sectionId) {
    const missionInfo = missionBySection[sectionId] || missionBySection['mapa-jogo'];
    return Math.max(0, Math.min(stageOrder.length - 1, missionInfo.order || 0));
  }

  function applyPresentationFocus(forcedSectionId) {
    const isPresentation = document.body.classList.contains('mode-apresentacao');
    const activeSection = forcedSectionId || getCurrentSectionId();
    const stageIndex = getStageIndexFromSection(activeSection);
    const targetStageId = stageOrder[stageIndex];

    headers.forEach((h1) => {
      const content = h1.nextElementSibling;
      const isTarget = h1.id === targetStageId;

      if (!isPresentation) {
        h1.classList.remove('presentation-hidden');
        if (content && content.classList.contains('lesson-content')) {
          content.classList.remove('presentation-hidden');
        }
        return;
      }

      if (h1.id === 'mapa-jogo') {
        h1.classList.remove('presentation-hidden');
      } else {
        h1.classList.toggle('presentation-hidden', !isTarget);
      }

      if (content && content.classList.contains('lesson-content')) {
        content.classList.toggle('presentation-hidden', !isTarget);
      }
    });
  }

  function goStage(stepDelta) {
    const currentSection = getCurrentSectionId();
    const currentIndex = getStageIndexFromSection(currentSection);
    const nextIndex = Math.max(0, Math.min(stageOrder.length - 1, currentIndex + stepDelta));
    const nextId = stageOrder[nextIndex];
    window.location.hash = '#' + nextId;
  }

  function applyMode(mode) {
    const validModes = new Set(['aluno', 'professor', 'apresentacao']);
    const finalMode = validModes.has(mode) ? mode : 'aluno';
    document.body.classList.toggle('mode-professor', finalMode === 'professor');
    document.body.classList.toggle('mode-aluno', finalMode === 'aluno');
    document.body.classList.toggle('mode-apresentacao', finalMode === 'apresentacao');
    modeButtons.forEach((btn) => {
      btn.classList.toggle('active', btn.dataset.mode === finalMode);
    });
    if (hudModo) {
      if (finalMode === 'professor') hudModo.textContent = 'Professor';
      else if (finalMode === 'apresentacao') hudModo.textContent = 'Apresentacao';
      else hudModo.textContent = 'Aluno';
    }
    const studentControls = document.getElementById('student-controls');
    if (studentControls) {
      studentControls.style.display = finalMode === 'aluno' ? 'flex' : 'none';
    }
    if (roadmapPanel) {
      roadmapPanel.open = finalMode === 'professor';
    }
    applyStudentLocks();
    refreshStudentActionButton();
    applyStudentSingleScreen();
    renderStudentSlides();
    applyPresentationFocus();
    updateLessonFromScroll();
    updateSectionFromScroll();
    try {
      localStorage.setItem('mostrabot_modo', finalMode);
    } catch (error) {
      // Silent fallback when storage is unavailable.
    }
  }

  function applyFocus(focus) {
    const focusValue = focus || 'all';
    const filterables = document.querySelectorAll('.mission-card[data-module], .lesson-card[data-module]');
    filterables.forEach((el) => {
      const mods = (el.dataset.module || '').split(/\s+/);
      const visible = focusValue === 'all' || mods.includes(focusValue);
      el.classList.toggle('hidden-by-focus', !visible);
    });
    focusChips.forEach((chip) => {
      chip.classList.toggle('active', chip.dataset.focus === focusValue);
    });
    if (hudModulo) hudModulo.textContent = moduleLabel[focusValue] || '-';
    updateLessonFromScroll();
  }

  focusChips.forEach((chip) => {
    chip.addEventListener('click', () => applyFocus(chip.dataset.focus));
  });
  modeButtons.forEach((btn) => {
    btn.addEventListener('click', () => applyMode(btn.dataset.mode));
  });
  stageButtons.forEach((btn) => {
    btn.addEventListener('click', () => {
      const dir = btn.dataset.stageNav === 'prev' ? -1 : 1;
      goStage(dir);
    });
  });
  if (ageSelect) {
    ageSelect.addEventListener('change', () => {
      currentAge = ageSelect.value || '9-11';
      try {
        localStorage.setItem('mostrabot_age', currentAge);
      } catch (error) {}
      applyStudentLocks();
      refreshMissionTaskStates();
      refreshStudentActionButton();
      applyStudentSingleScreen();
      renderStudentSlides();
      syncHashTarget();
    });
  }
  if (backStageBtn) {
    backStageBtn.addEventListener('click', () => {
      if (!document.body.classList.contains('mode-aluno')) return;
      const unlocked = getUnlockedStage();
      if (unlocked <= 0) return;
      const nextUnlocked = unlocked - 1;
      setUnlockedStage(nextUnlocked);
      const completed = getCompletedMissions().filter((idx) => idx <= nextUnlocked);
      setCompletedMissions(completed);
      const progress = getTaskProgress();
      Object.keys(progress).forEach((taskKey) => {
        const sectionId = String(taskKey || '').split('::')[0];
        const info = missionBySection[sectionId];
        if (info && typeof info.order === 'number' && info.order > nextUnlocked) {
          delete progress[taskKey];
        }
      });
      setTaskProgress(progress);
      applyStudentLocks();
      refreshMissionTaskStates();
      refreshStudentActionButton();
      applyStudentSingleScreen();
      renderStudentSlides();
      window.location.hash = '#' + (stageOrder[nextUnlocked] || 'intro');
    });
  }
  if (completeStageBtn) {
    completeStageBtn.addEventListener('click', () => {
      if (!document.body.classList.contains('mode-aluno')) return;
      const currentSection = getCurrentSectionId();
      const currentIdx = getStageIndexFromSection(currentSection);
      const unlocked = getUnlockedStage();
      const completed = getCompletedMissions();
      if (!completed.includes(currentIdx)) {
        completed.push(currentIdx);
        setCompletedMissions(completed);
      }
      if (currentIdx <= unlocked && unlocked < stageOrder.length - 1) {
        const nextUnlocked = unlocked + 1;
        setUnlockedStage(nextUnlocked);
        window.location.hash = '#' + (stageOrder[nextUnlocked] || 'intro');
      }
      applyStudentLocks();
      refreshStudentActionButton();
      applyStudentSingleScreen();
      renderStudentSlides();
    });
  }
  if (resetProgressBtn) {
    resetProgressBtn.addEventListener('click', () => {
      if (!document.body.classList.contains('mode-aluno')) return;
      const confirmed = window.confirm('Resetar progresso desta faixa etaria?');
      if (!confirmed) return;
      setUnlockedStage(0);
      setCompletedMissions([]);
      setTaskProgress({});
      setReadOnceProgress({});
      Object.keys(slideIndexBySection).forEach((key) => delete slideIndexBySection[key]);
      applyStudentLocks();
      refreshMissionTaskStates();
      refreshStudentActionButton();
      applyStudentSingleScreen();
      renderStudentSlides();
      window.location.hash = '#intro';
      window.scrollTo({ top: 0, behavior: 'auto' });
    });
  }
  if (exitPresentationBtn) {
    exitPresentationBtn.addEventListener('click', () => applyMode('aluno'));
  }
  if (studentStepPrev) {
    studentStepPrev.addEventListener('click', () => changeStudentSlide(-1));
  }
  if (studentStepNext) {
    studentStepNext.addEventListener('click', () => changeStudentSlide(1));
  }
  if (studentFabPrev) {
    studentFabPrev.addEventListener('click', () => changeStudentSlide(-1));
  }
  if (studentFabNext) {
    studentFabNext.addEventListener('click', () => changeStudentSlide(1));
  }
  if (robotGuideTrigger && robotDialog) {
    robotGuideTrigger.addEventListener('click', () => {
      robotDialog.hidden = false;
    });
  }
  if (robotDialog && robotDialogClose) {
    robotDialogClose.addEventListener('click', () => {
      robotDialog.hidden = true;
    });
    robotDialog.addEventListener('click', (event) => {
      if (event.target === robotDialog) robotDialog.hidden = true;
    });
  }

  document.addEventListener('keydown', (event) => {
    const target = event.target;
    const tag = target && target.tagName ? target.tagName.toLowerCase() : '';
    const isTypingField = tag === 'input' || tag === 'textarea' || (target && target.isContentEditable);
    if (isTypingField) return;

    const key = (event.key || '').toLowerCase();
    if (event.key === 'Escape' && robotDialog && !robotDialog.hidden) {
      robotDialog.hidden = true;
      return;
    }
    if (key === 'a') applyMode('aluno');
    if (key === 'p') applyMode('professor');
    if (key === 'd') applyMode('apresentacao');
    if (event.key === 'Escape') applyMode('aluno');
    if (document.body.classList.contains('mode-aluno') && event.key === 'ArrowLeft') {
      event.preventDefault();
      changeStudentSlide(-1);
    }
    if (document.body.classList.contains('mode-aluno') && event.key === 'ArrowRight') {
      event.preventDefault();
      changeStudentSlide(1);
    }
    if (document.body.classList.contains('mode-apresentacao') && event.key === 'ArrowLeft') goStage(-1);
    if (document.body.classList.contains('mode-apresentacao') && event.key === 'ArrowRight') goStage(1);
  });

  function syncHashTarget() {
    const targetId = window.location.hash.replace('#', '');
    if (!targetId) return;
    if (document.body.classList.contains('mode-aluno')) {
      const info = missionBySection[targetId];
      if (info && typeof info.order === 'number' && info.order !== getUnlockedStage()) {
        const fallbackId = stageOrder[getUnlockedStage()] || 'intro';
        window.location.hash = '#' + fallbackId;
        return;
      }
    }
    const target = document.getElementById(targetId);
    if (!target) return;
    openSectionFromTarget(target);
    setActiveSection(targetId);
    applyPresentationFocus(targetId);
    renderStudentSlides();
  }

  window.addEventListener('hashchange', syncHashTarget);
  window.addEventListener('scroll', () => {
    if (document.body.classList.contains('mode-aluno')) {
      applyStudentSingleScreen();
      renderStudentSlides();
      updateReadGateByScroll();
      return;
    }
    updateSectionFromScroll();
    updateLessonFromScroll();
    applyPresentationFocus();
  }, { passive: true });

  let savedMode = 'aluno';
  try {
    const storageAge = localStorage.getItem('mostrabot_age');
    if (storageAge) currentAge = storageAge;
  } catch (error) {
    currentAge = '9-11';
  }
  if (ageSelect) ageSelect.value = currentAge;
  try {
    const storageMode = localStorage.getItem('mostrabot_modo');
    if (storageMode === 'professor' || storageMode === 'aluno' || storageMode === 'apresentacao') {
      savedMode = storageMode;
    }
  } catch (error) {
    savedMode = 'aluno';
  }

  loadGameConfig();
  sortMissionCardsByOrder();
  enhanceMissionTasks();
  enforceExternalPjeLinks();
  enhanceCodeExamples();
  setUnlockedStage(getUnlockedStage());
  setCompletedMissions(getCompletedMissions());
  refreshMissionTaskStates();
  refreshStudentActionButton();
  applyFocus('all');
  applyMode(savedMode);
  syncHashTarget();
  updateSectionFromScroll();
  updateLessonFromScroll();
  applyStudentSingleScreen();
  renderStudentSlides();
  applyPresentationFocus();
})();
</script>

</body>
</html>
